@using NRCan.Datahub.Metadata.Model
@using NRCan.Datahub.Metadata.DTO
@using NRCan.Datahub.CKAN.Package

@if (_fieldValues != null)
{
    <MetadataEditor Preview="_preview"
                    Definitions="@_definitions"
                    FieldValues="@_fieldValues"
                    OnFieldChanged="FieldChanged" />
}

@code {

    [Inject]
    public IMetadataBrokerService MetadataBrokerService { get; set; }

    /// <summary>
    /// Object ID to edit or add metadata
    /// </summary>
    [Parameter]
    public string ObjectId { get; set; } = "7aa33e32-44a1-4ca4-b76c-ccb98c7b8e0b";

    private FieldDefinitions _definitions;
    private FieldValueContainer _fieldValues;
    private bool _preview = false;

    protected override async Task OnInitializedAsync()
    {
        _fieldValues = await MetadataBrokerService.GetMetadataContext(ObjectId);
        _definitions = _fieldValues.Definitions;
    }

    public void TogglePreview()
    {
        _preview = !_preview;
        StateHasChanged();
    }

    public bool IsRequiredMetadataValid => _fieldValues?.ValidateRequired() == true;

    public async Task SaveChanges()
    {
        await MetadataBrokerService.SaveMetadata(_fieldValues);
        StateHasChanged();
    }

    [Inject]
    public ICKANService CKANService { get; set; }
    
    public async Task SavePackage()
    {
        var result = await CKANService.CreatePackage(_fieldValues);
        // ...
    }

    private void FieldChanged(ObjectFieldValue field)
    {
        StateHasChanged();
    }
}

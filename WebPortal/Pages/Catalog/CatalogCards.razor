@*CatalogCard.razor*@
@using Datahub.Metadata.DTO
@using Datahub.Metadata.Model
@using Datahub.Metadata.Utils
@inject UIControlsService uiControlService

@if (CatalogResult is null)
{
    <CardSkeleton />
}
else
{
    <div class="card">
        <div class="topright">
            <div style="@($"--security-text-color: {_securityClassColor}")" class="securityclass">
                <i class="@($"fad fa-{_projectIcon}")"></i>
                <p><b>@Localizer["DISCOVERY-LABELS.DATA SENSITIVITY"]: @Localizer[@CatalogResult.SecurityClass]</b></p>
            </div>            
            <div title="@GetFieldDefinitions("name")" class="rowheader">
                <i style="margin-top: 0.2rem;" class="@_fileIcon"></i>
                <p>@_allFieldValues["name"]</p>     
            </div>
            <AuthorizeView Roles=@GetCardAdminRoles()>
                <div class="rowheader">                
                    <AeButton class=@GetMetadataButtonColor() OnClickEvent=@ShowMetadataEditor>@Localizer[GetMetadataButtonText()]</AeButton>                
                </div>
            </AuthorizeView>
        </div>
        <div class="topleft">            
            <div title="@GetDivTitleTitle()" class="datasetname">
                <p>@GetTitle()</p>                 
            </div>           
        </div>
        <div title="@GetDivTitleDescription()" class="title-and-subject">  
            <AeTypography Variant="p no-margin">@GetDescription()</AeTypography>
        </div>
        <div class="details-left">
            <div title="@GetDivTitleSubject()"><AeTypography Variant="p no-margin"><b>@Localizer["Subject"]: </b>@GetLabel("subject")</AeTypography></div>
            <AeTypography Variant="p no-margin"><b>@Localizer["DISCOVERY-LABELS.Data Type"]: </b>@AccessorFunctions[4](@CatalogResult)</AeTypography>
            @if (!string.IsNullOrWhiteSpace(_fileType))
            {
                <AeTypography Variant="p no-margin"><b>@Localizer["DISCOVERY-LABELS.File Format"]: </b>@_fileType</AeTypography>
            }
            <AeTypography Variant="p no-margin"><b>@Localizer["DISCOVERY-LABELS.Contact Information"]: </b>@AccessorFunctions[3](@CatalogResult)</AeTypography>
            @if (Project is not null)
            {
                <AeTypography Variant="p no-margin"><b>@Localizer["Location"]: </b><DHLink DataProject="@(Project.Project_Acronym_CD)">@Project.ProjectName</DHLink></AeTypography>
            }   
        </div>
        <div class="details-right">
            <AeTypography Variant="p no-margin"><b>@Localizer["Sector"]: </b>@AccessorFunctions[1](@CatalogResult)</AeTypography>
            <AeTypography Variant="p no-margin"><b>@Localizer["Branch"]: </b>@AccessorFunctions[2](@CatalogResult)</AeTypography>
            <div title="@GetFieldDefinitions("collection")"><AeTypography Variant="p no-margin"><b>@Localizer["DISCOVERY-LABELS.Collection Type"]: </b>@GetLabel("collection")</AeTypography></div>
        </div>
        <div class="bottom-row">
            <div class="key-words">
                @foreach(var tag in _tags)
                {
                    <AeTag Title="@tag" class="dark"></AeTag>                
                }
            </div>
            <div class="buttons">                
                <p>@RenderFunctions[6](@CatalogResult)</p>
            </div>
        </div>
    </div>
}
@code {

    [Parameter]
    public CatalogObjectResult CatalogResult { get; init; }

    [Parameter]
    public Datahub_Project Project { get; set; }

    [Parameter]
    public List<Func<CatalogObjectResult, string>> AccessorFunctions { get; set; }

    [Parameter]
    public List<Func<CatalogObjectResult, RenderFragment>> RenderFunctions { get; set; }

    [Parameter]
    public bool IsFrench { get; set; }

    private string _projectIcon => CatalogResult.SecurityClass.Contains("Protect") ? $"fas fa-lock-alt" : $"fas fa-lock-open-alt";
    private string _fileIcon => GetFileIcon();
    private string _securityClassColor => GetSecurityClassColor();
    private string _metadataButtonColor => GetMetadataButtonColor();

    private FieldValueContainer _fieldValues;
    private Dictionary<string, string> _allFieldValues;
    private List<string> _tags;
    private string _fileType;

    private string GetDivTitleTitle() => IsFrench ? GetFieldDefinitions("title_translated_fr") : GetFieldDefinitions("title_translated_en");
    private string GetDivTitleDescription() => IsFrench ? GetFieldDefinitions("notes_translated_fr") : GetFieldDefinitions("notes_translated_en");
    private string GetTitle() => IsFrench ? _allFieldValues["title_translated_fr"] : _allFieldValues["title_translated_en"];
    private string GetDescription() => IsFrench ? _allFieldValues["notes_translated_fr"] : _allFieldValues["notes_translated_en"];

    protected override void OnInitialized()
    {
        _fieldValues = CatalogResult.Metadata;
        IndexFieldValues(_fieldValues);
        SetAllTags();
    }

    private string GetLabel(string label) 
    {
        var subjects = _fieldValues.GetSelectedChoices(label).Select(s => s.Label).ToList();
        return subjects.Any() ? subjects[0] : string.Empty;
    }

    private string GetDivTitleSubject() => GetFieldDefinitions("subject");

    private async Task ShowMetadataEditor()
    {
        RenderFragment metadataEditor = 
        @<ObjectMetadataEditor 
            @key=@CatalogResult.ObjectMetadataId
            ObjectId=@CatalogResult.ObjectMetadataId.ToString() 
            DefaultMetadataId=@CatalogResult.Location
            Name=@CatalogResult.Name
            Location=@CatalogResult.Location
            SecurityClass=@CatalogResult.SecurityClass
            SaveButtonLabel=@Localizer["OPENDATA-WIZARD.Save_button"] 
            OnSave="HandleSave"
            OnDiscard="HandleClose"
            ValidateRequired=true
            ProfileName="catalog"
            ObjectType=@MetadataObjectType.File
            UpdateCatalog=true
        />;
        await uiControlService.ToggleModal(@<RenderFragmentModal Fragment=@metadataEditor />
    );
    }

    private async Task HandleSave(FieldValueContainer values)
    {
        CatalogResult.Metadata = values;
        IndexFieldValues(values);
        UpdateCatalogData(values);
        await InvokeAsync(StateHasChanged);
        await uiControlService.ToggleModal();
    }

    private async Task HandleClose()
    {
        await uiControlService.ToggleModal();
    }

    private void UpdateCatalogData(FieldValueContainer values)
    {
        var digest = values.GetCatalogDigest();
        CatalogResult.Sector = digest.Sector;
        CatalogResult.Branch = digest.Branch;
    }

    private string GetCardAdminRoles()
    {
        return Project is null ?  RoleConstants.DATAHUB_ROLE_ADMIN : $"{Project.Project_Acronym_CD}-admin {RoleConstants.DATAHUB_ROLE_ADMIN}";
    }

    private void SetAllTags()
    {
        _tags = new();
        var keywords = IsFrench ? "keywords_fr" : "keywords_en";        
        var eTags = _allFieldValues[keywords] ?? string.Empty;
        var eTagsList = eTags.Split(',').ToList();
        _tags.AddRange(eTagsList);
    }

    private string GetMetadataButtonText()
    {
        return CatalogResult.IsCatalogComplete ? "Update Metadata" : "Complete Metadata";
    }

    private string GetMetadataButtonColor()
    {
        return CatalogResult.IsCatalogComplete ? "blue" : "red";
    }

    private string GetSecurityClassColor()
    {
        var secClass = CatalogResult.SecurityClass;
        switch (secClass.ToLower())
        {
            case "protected a":
                return "#d69e2e";
            case "protected b":
                return "#e53e3e";
            default:
                return "#38a169";
        }
    }

    private string GetFileIcon()
    {
        var fileName = _allFieldValues["name"];
        _fileType = Path.GetExtension(fileName);
        _fileType = _fileType.Replace(".", "");
        return DatahubTools.GetFileTypeIcon(_fileType);
    }

    private void IndexFieldValues(FieldValueContainer fieldValues)
    {
        var names = fieldValues.GetAllFieldNames();
        _allFieldValues = names.ToDictionary(n => n, n => fieldValues.GetValue(n));
    }

    private string GetFieldDefinitions(string field)
    {
        return _fieldValues.Definitions.Get(field).Description;
    }

    private List<FieldChoice> GetOrganizationChoices(List<OrganizationLevel> levels, bool cascades)
    {
        return levels.Select(l => new FieldChoice()
        {
            Value_TXT = $"{l.Id}",
            Cascading_Value_TXT = cascades ? $"{l.ParentId}" : null,
            Label_English_TXT = l.EnglishLabel,
            Label_French_TXT = l.FrenchLabel
        }).ToList();
    }
}
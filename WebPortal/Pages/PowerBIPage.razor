@page "/powerbi"

@using Microsoft.EntityFrameworkCore.Query
@using Microsoft.EntityFrameworkCore;
@using Microsoft.PowerBI.Api.Models
@inject IStringLocalizer<DataLabels> DataLocalizer
@inject NavigationManager NavigationManager
@inject IJSRuntime JsInterop
@inject PowerBiServiceApi PowerBiServiceApi
@using Microsoft.Identity.Web
@inject MicrosoftIdentityConsentAndConditionalAccessHandler ConsentHandler

<div style="padding-left: 2rem;padding-right: 2rem">

<AeTypography Variant="h1">@Localizer["PowerBI"]</AeTypography>
<AeTypography Variant="h2">@Localizer["Featured Data Sets"]</AeTypography>

@if (!isDatasetsLoaded)
{
    <Spinner />
}
else
{
<div class="ae flex wrap">
@foreach (var ds in dataSets)
{
<AeCard style="width: 300px" class="small">
    <Header>
        <AeTypography style="flex-grow: 1">@ds.Name</AeTypography>
        <AeTypography Variant="a" href="@($"https://app.powerbi.com/datahub/datasets/{ds.Id}")">More</AeTypography>
    </Header>
    <ChildContent>
        <AeTypography>@ds.Description</AeTypography>
    </ChildContent>
    <Footer>
        <AeTypography>@(ds.EndorsementDetails?.Endorsement)</AeTypography>
    </Footer>
</AeCard>
}
</div>
}
<AeTypography Variant="h2">@Localizer["My Workspaces"]</AeTypography>

@if (!isWorkspacesLoaded)
{
    <Spinner />
}
else
{

}

</div>
@code {
    private bool isDatasetsLoaded = false;
    private bool isWorkspacesLoaded = false;

    private List<Dataset> dataSets;

    protected override async Task OnInitializedAsync()
    {
        Task.Run(async () =>
        {
            try
            {
                dataSets = await PowerBiServiceApi.GetAllDatasetsAsync();
                isWorkspacesLoaded = true;
                isDatasetsLoaded = true;
                InvokeAsync(StateHasChanged);
                //            StateHasChanged();
            }
            catch (Exception ex)
            {
                ConsentHandler.HandleException(ex);
            }
        });
    }

}

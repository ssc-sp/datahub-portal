@page "/sharingworkflow/{FileId}"
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Graph
@inject IStringLocalizer<SharingWorkflow> Localizer
@inject NavigationManager _navManager
@inject IPublicDataFileService _publicDataService
@inject IUserInformationService _userInfoService

<div style="padding-left: 2rem;padding-right: 2rem">
    <AeFlex Vertical>
        <AeTypography Variant="h1">Data Sharing</AeTypography>
    </AeFlex>
    
    <AuthorizeView Roles="DHPGLIST-admin" Context="hidden_in_dev">
    <AeCard>
        <Header>
        <AeTypography Variant="h1">@Localizer["Share Data in Canada Open Data Portal"]</AeTypography>
        </Header>
        <ChildContent>
            <p>
                This workflow will enable to upload your data to the Canada Open Data Portal. It includes the metadata management and approvals.
            </p>
        </ChildContent>
        <Footer>
            <AeButton OnClickEvent=@OpenDataClicked Disabled=@_openDataDisabled >@Localizer["Start Workflow"]</AeButton>
		</Footer>
    </AeCard>
    </AuthorizeView>
    
    <AeCard>
        <Header>
        <AeTypography Variant="h1">@Localizer["Share Data using DataHub public URLs"]</AeTypography>
        </Header>
        <ChildContent>
            <p>
                This workflow will generate public links (data-nrcan.canada.ca, donnees-rncan.canada.ca) from your files to reference them on external sites or publications.
            </p>
        </ChildContent>
        <Footer>
            <AeButton OnClickEvent=@PublicUrlClicked Disabled=@_publicUrlDisabled >@Localizer["Start Workflow"]</AeButton>
		</Footer>
    </AeCard>
</div>



@code {

    [Parameter]
    public string FileId { get; set; }

    private string Filename { get; set; }
    private string Folderpath { get; set; }
    private string ProjectCode { get; set; }

    private User _user { get; set; }
    private bool _userLoaded => _user != null;
    private bool _publicUrlDisabled => !_userLoaded;
    private bool _openDataDisabled => !_userLoaded;

    private string PublicUrlSharingUrl => $"/share/public/{FileId}";
    private string OpenDataSharingUrl => $"/share/opendata/{FileId}";

    public async Task OpenDataClicked()
    {
        var filemd = new FileMetaData()
        {
            fileid = FileId,
            filename = Filename,
            folderpath = Folderpath
        };

        await _publicDataService.CreateDataSharingRequest(filemd, ProjectCode, _user, true);
        _navManager.NavigateTo(OpenDataSharingUrl);
    }

    public async Task PublicUrlClicked()
    {   
        var filemd = new FileMetaData()
        {
            fileid = FileId,
            filename = Filename,
            folderpath = Folderpath
        };

        await _publicDataService.CreateDataSharingRequest(filemd, ProjectCode, _user);
        _navManager.NavigateTo(PublicUrlSharingUrl);
    }

    private string GetFirstQueryValue(IDictionary<string, Microsoft.Extensions.Primitives.StringValues> query, string paramKey)
    {
        if (query.TryGetValue(paramKey, out var param))
        {
            return param.First();
        }
        else
        {
            return null;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var userTask = _userInfoService.GetUserAsync();
        
        Guid fileIdGuid;
        if (!Guid.TryParse(FileId, out fileIdGuid))
        {
            // return to homepage if guid is invalid
            _navManager.NavigateTo("/");
        }

        var fileInfoTask = _publicDataService.LoadPublicUrlSharedFileInfo(fileIdGuid);

        var uri = _navManager.ToAbsoluteUri(_navManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        Filename = GetFirstQueryValue(query, "filename");
        Folderpath = GetFirstQueryValue(query, "folderpath");
        ProjectCode = GetFirstQueryValue(query, "project");

        var existingPublicFile = await fileInfoTask;
        if (existingPublicFile != null)
        {
            if (existingPublicFile.IsOpenDataRequest_FLAG)
            {
                _navManager.NavigateTo(OpenDataSharingUrl);
            }
            else
            {
                _navManager.NavigateTo(PublicUrlSharingUrl);
            }
        }

        _user = await userTask;
    }

}

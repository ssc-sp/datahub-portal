@page "/project/{ProjectAcronym}/datasharing"
@inject IPublicDataFileService PublicDataFileService
@inject IMSGraphService GraphService
@inject IUserInformationService UserService
@inject UIControlsService UI
@inject NotifierService NotifierService
@implements IDisposable

<style>
    .table-card {
        margin-left: 2rem;
        margin-bottom: 2rem;
        padding-right: 2rem;
        width: 60vw;
    }
</style>

<AeFlex Vertical>

    <AeTypography Variant="h2" style="margin-left: 2rem;">@Localizer[$"{LOCALIZATION_PREFIX}.Title"]</AeTypography>

    @if (ShouldShowRequestsAwaitingApproval)
    {
        <AeCard class="table-card">

            <AeTypography Variant="h3">@Localizer[$"{LOCALIZATION_PREFIX}.RequestsPendingApproval"]</AeTypography>

            @if(hasFilesAwaitingApproval)
            {
                <AeTable
                    Accessors=@awaitingApprovalAccessors
                    Renderers=@awaitingApprovalRenderers
                    T=@SharedDataFile
                    Dataset=@publicDataFilesAwaitingApproval
                    Headers=@awaitingApprovalHeaders
                    />
            }
            else
            {
                <AeTypography Variant="p">@Localizer[$"{LOCALIZATION_PREFIX}.NoFilesAwaitingApproval"]</AeTypography>
            }

            <div>&nbsp;</div>
        </AeCard>
    }

    <AeCard class="table-card">

        <AeTypography Variant="h3">@Localizer[$"{LOCALIZATION_PREFIX}.YourSharedFiles"]</AeTypography>

        @if (hasOwnSharedFiles)
        {
            <AeTable
                Accessors=@usersOwnFilesAccessors
                Renderers=@usersOwnFilesRenderers
                T=@SharedDataFile
                Dataset=@usersOwnSharedFiles
                Headers=@usersOwnFilesHeaders
                />
        }
        else
        {
            <AeTypography Variant="p">@Localizer[$"{LOCALIZATION_PREFIX}.NoOwnSharedFiles"]</AeTypography>
        }

        <div>&nbsp;</div>
    </AeCard>

    @if (ShouldShowAllSharingRequests)
    {
        <AeCard class="table-card">

            <AeTypography Variant="h3">@Localizer[$"{LOCALIZATION_PREFIX}.OthersSharedFiles"]</AeTypography>

            @if (hasOtherUsersFiles)
            {
                <AeTable
                    Accessors=@otherUsersFilesAccessors
                    Renderers=@otherUsersFilesRenderers
                    T=@SharedDataFile
                    Dataset=@otherUsersSharedFiles
                    Headers=@otherUsersFilesHeaders
                    />
            }
            else
            {
                <AeTypography Variant="p">@Localizer[$"{LOCALIZATION_PREFIX}.NoOtherSharedFiles"]</AeTypography>
            }

            <div>&nbsp;</div>
        </AeCard>
    }


    <div>&nbsp;</div>
</AeFlex>

@code {
    [Parameter]
    public string ProjectAcronym { get; set; }

    public static readonly string NOTIFICATION_UPDATE_KEY = "datasharing";
    public static readonly string LOCALIZATION_PREFIX = "DATA-SHARING-DASHBOARD";

    private List<SharedDataFile> publicDataFilesAwaitingApproval = new();
    private List<SharedDataFile> usersOwnSharedFiles = new();
    private List<SharedDataFile> otherUsersSharedFiles = new();
    private bool hasFilesAwaitingApproval => publicDataFilesAwaitingApproval.Count > 0;
    private bool hasOwnSharedFiles => usersOwnSharedFiles.Count > 0;
    private bool hasOtherUsersFiles => otherUsersSharedFiles.Count > 0;


    private string currentUserId;
    private bool isDataApprover = false;

    //TODO proper conditions for these
    private bool ShouldShowRequestsAwaitingApproval => isDataApprover;
    private bool ShouldShowAllSharingRequests => true;
    
    
    private List<string> LocalizeHeaders(List<string> headerKeys)
    {
        return headerKeys.Select(k => Localizer[$"{LOCALIZATION_PREFIX}.{k}"].ToString()).ToList();
    }
    
    private List<string> awaitingApprovalHeaderKeys = new List<string>()
    {
        "Filename", "RequestingUser", "SubmissionDate"
    };
    private List<string> awaitingApprovalHeaders => LocalizeHeaders(awaitingApprovalHeaderKeys);

    private List<string> usersOwnFilesHeaderKeys = new List<string>()
    {
        "Filename", "SubmissionDate", "Type", "Status", "PublicationDate"
    };
    private List<string> usersOwnFilesHeaders => LocalizeHeaders(usersOwnFilesHeaderKeys);

    private List<string> otherUsersFilesHeaderKeys = new List<string>()
    {
        "Filename", "Owner", "Type", "Status"
    };
    private List<string> otherUsersFilesHeaders => LocalizeHeaders(otherUsersFilesHeaderKeys);

    private List<Func<SharedDataFile, string>> awaitingApprovalAccessors = new();
    private List<Func<SharedDataFile, string>> usersOwnFilesAccessors = new();
    private List<Func<SharedDataFile, string>> otherUsersFilesAccessors = new();

    private List<Func<SharedDataFile, RenderFragment>> awaitingApprovalRenderers = new();
    private List<Func<SharedDataFile, RenderFragment>> usersOwnFilesRenderers = new();
    private List<Func<SharedDataFile, RenderFragment>> otherUsersFilesRenderers = new();

    private string GetSharingWorkflowUrl(SharedDataFile f)
    {
        return $"/sharingworkflow/{f.File_ID}";
    }

    public async Task OnNotify(string key, bool reloadData)
    {
        if (key == NOTIFICATION_UPDATE_KEY)
        {
            if (reloadData)
            {
                await LoadSharingRequests();
            }
            await InvokeAsync(() => StateHasChanged());
            UI.ToggleRightSidebar();
        }
    }

    private void PopupApprovalModal(SharedDataFile f)
    {
        UI.ToggleRightSidebar(
    @<ApprovePublicUrlShareRequestModal SharedFile=@f />);
    }

    private async Task LoadSharingRequests()
    {
        var loadAllSharedFilesForProjectTask = PublicDataFileService.GetAllSharedDataForProject(ProjectAcronym);
        var loadCurrentUserIdTask = UserService.GetUserIdString();

        var allSharedFilesForProject = await loadAllSharedFilesForProjectTask;
        currentUserId = await loadCurrentUserIdTask;

        usersOwnSharedFiles = allSharedFilesForProject.Where(f => f.RequestingUser_ID == currentUserId).ToList();
        otherUsersSharedFiles = allSharedFilesForProject.Except(usersOwnSharedFiles).ToList();
        publicDataFilesAwaitingApproval = allSharedFilesForProject
            .Where(f => f.SubmittedDate_DT.HasValue 
                && f.SubmittedDate_DT <= DateTime.UtcNow 
                && !f.ApprovedDate_DT.HasValue
                && !f.IsOpenDataRequest_FLAG)
            .ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        var baseTask = base.OnInitializedAsync();
        var loadRequestsTask = LoadSharingRequests();

        NotifierService.Notify += OnNotify;

        awaitingApprovalAccessors = new List<Func<SharedDataFile, string>>()
        {
            f => f.Filename_TXT,
            null,
            f => f.SubmittedDate_DT?.ToShortDateString() ?? "--"
        };

        usersOwnFilesAccessors = new List<Func<SharedDataFile, string>>()
        {
            f => f.Filename_TXT,
            f => f.SubmittedDate_DT?.ToShortDateString() ?? "--",
            f => f.IsOpenDataRequest_FLAG? Localizer[$"{LOCALIZATION_PREFIX}.OpenData"]: Localizer[$"{LOCALIZATION_PREFIX}.PublicUrl"],
            f => Localizer[f.GetStatusKey()],
            f => f.PublicationDate_DT?.ToShortDateString() ?? "--"
        };

        otherUsersFilesAccessors = new List<Func<SharedDataFile, string>>()
        {
            f => f.Filename_TXT,
            null,
            f => f.IsOpenDataRequest_FLAG? Localizer[$"{LOCALIZATION_PREFIX}.OpenData"]: Localizer[$"{LOCALIZATION_PREFIX}.PublicUrl"],
            f => Localizer[f.GetStatusKey()]
        };

        awaitingApprovalRenderers = new List<Func<SharedDataFile, RenderFragment>>()
        {
            f => @<a href="#" @onclick="() => PopupApprovalModal(f)" @onclick:preventDefault="true">@f.Filename_TXT</a>,
            f => @<div class="help icon-container"><GraphUserInformation UserId=@f.RequestingUser_ID IsUserNameRequested="true"></GraphUserInformation> </div>,
            null
        };

        usersOwnFilesRenderers = new List<Func<SharedDataFile, RenderFragment>>()
        {
            f => @<a href=@GetSharingWorkflowUrl(f)>@f.Filename_TXT</a>,
            null,
            null,
            null,
            null
        };

        otherUsersFilesRenderers = new List<Func<SharedDataFile, RenderFragment>>()
        {
            f => @<a href=@GetSharingWorkflowUrl(f)>@f.Filename_TXT</a>,
            f => @<div class="help icon-container"><GraphUserInformation UserId=@f.RequestingUser_ID IsUserNameRequested="true"></GraphUserInformation> </div>,    
            null,
            null
        };

        await loadRequestsTask;
        await baseTask;

        isDataApprover = await PublicDataFileService.IsUserProjectDataApprover(ProjectAcronym, currentUserId);
    }

    public void Dispose()
    {
        NotifierService.Notify -= OnNotify;
    }
    
}

@*PublicSharing.razor*@
@inject IDbContextFactory<DatahubProjectDBContext> _dbFactoryProject
@inject RequestManagementService _requestManagementService
@inject IPublicDataFileService _publicDataFileService

@if (Project is null)
{
    <ToolCard Loading/>
}
else
{
    <ToolCard
        Title=@Localizer["PROJECT-PAGE.PUBLIC-SHARING-CARD.Title"]
        Description=@Description>
        <Logo>
            <MudIcon Icon="fad fa-file-alt fa-xs"/>
        </Logo>
        <ToolActionsList>
            <DHLink Variant="h3" DataProject="@ProjectAcronym" LinkType="DatahubLinkType.DataSharingDashboard">
                <ToolActionButton LinkType="LinkType.Internal">
                    @Localizer["PROJECT-PAGE.PUBLIC-SHARING-CARD.Title"]
                </ToolActionButton>
            </DHLink>
        </ToolActionsList>
    </ToolCard>
}

@code {

    [CascadingParameter(Name = "Project")]
    private Datahub_Project Project { get; set; }

    [CascadingParameter(Name = "UserId")]
    public string UserId { get; set; }

    [CascadingParameter(Name = "GraphUser")]
    public Microsoft.Graph.User GraphUser { get; set; }

    public string Description => $"{Localizer["Share files to Open Data, Public URLs or geo.ca"]}. " +
      (_isDataApprover?Localizer["This project has {0} active file shared and {1} files waiting for approval.",_ownSharingRequestCount,_sharingRequestAwaitingApprovalCount]
        :Localizer["The current project has {0} active file shared",_ownSharingRequestCount]);

    private bool _isDataApprover;
    private int _sharingRequestAwaitingApprovalCount;
    private int _ownSharingRequestCount;

    private string ProjectAcronym => Project?.Project_Acronym_CD;

    protected override async Task OnInitializedAsync()
    {
        await using var projectDbContext = await _dbFactoryProject.CreateDbContextAsync();
        if (UserId != null)
        {
            _isDataApprover = await projectDbContext.Project_Users
                .Where(u => u.User_ID == UserId && Project == u.Project)
                .AnyAsync(u => u.IsDataApprover);
                
            _sharingRequestAwaitingApprovalCount = await _publicDataFileService.GetDataSharingRequestsAwaitingApprovalCount(ProjectAcronym);
            _ownSharingRequestCount = await _publicDataFileService.GetUsersOwnDataSharingRequestsCount(ProjectAcronym, UserId);
        }
    }
}
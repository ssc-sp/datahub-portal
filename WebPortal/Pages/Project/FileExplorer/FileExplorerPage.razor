@inject IDbContextFactory<DatahubProjectDBContext> _dbFactoryProject
@inject DataRetrievalService _dataRetrievalService

@page "/projects/{ProjectAcronymParam}/filelist"
@using Datahub.Core.Components.PageBanner
@using Datahub.Portal.Pages.Project.FileExplorer.ResourcePages

<DHPageTitle PageTitleKey="@_projectName"/>
<DHPageAlert Title="How to use Project Storage" Key="@PageAlert.Storage" WikiLinkEN="Onboarding---Project-Storage" WikiLinkFR="Onboarding---Project-Storage"/>

<AeTypography style="margin-top: 0;" Variant="h1">@Localizer["Storage Explorer"]</AeTypography>

<CascadingValue Value="@ProjectAcronymParam" Name="ProjectAcronym">
    <div class="file-explorer-layout-wrapper">
        <TabControl TabIndex="@_tabIndex" OnChangeTab="@OnChangeTab">
            @foreach (var (control, content, forceGapLeft) in _tabs)
            {
                    <TabPage ForceGapToLeft="forceGapLeft">
                        <Control>
                            <AeTypography>@control</AeTypography>
                        </Control>
                        <ChildContent>
                            @content
                        </ChildContent>
                    </TabPage>
            }
        </TabControl>
    </div>
</CascadingValue>

@code {

    [Parameter]
    public string ProjectAcronymParam { get; set; }

    private int _tabIndex;
    private string _projectName;
    private List<(string, RenderFragment, bool)> _tabs = new();

    protected override async Task OnInitializedAsync()
    {
        await using var projectContext = await _dbFactoryProject.CreateDbContextAsync();

        _projectName = await projectContext.Projects
            .Where(p => p.Project_Acronym_CD == ProjectAcronymParam)
            .Select(p => p.ProjectName)
            .FirstOrDefaultAsync();
        
        _tabs = await GetTabs();
    }

    private void OnChangeTab(int tabIndex)
    {
        _tabIndex = tabIndex;
    }

    private async Task<List<(string, RenderFragment, bool)>> GetTabs()
    {
        await Task.Delay(1);

        var containers = await _dataRetrievalService.GetProjectContainersAsync(ProjectAcronymParam);

        var tabs = new List<(string, RenderFragment, bool)>();
        containers.ForEach(container => tabs.Add((Localizer[container], @<FileExplorer ContainerName="@container"/>, false)));

        tabs.Add((Localizer["AzCopy"], @<AzCopy/>, true));
        tabs.Add((Localizer["Databricks Access"], @<Databricks />, false));

        return tabs;
    }

}
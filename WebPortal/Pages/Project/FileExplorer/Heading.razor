@inject ApiService _apiService
@inject IJSRuntime _jsRuntime

<div class="heading">
    <AeTypography Variant="h1">@Localizer["Storage Explorer"]</AeTypography>
    <div class="breadcrumbs">
        <AeButton class="light" @onclick="@(async () => await SetCurrentFolder.InvokeAsync("/"))">root</AeButton>
        @foreach (var folder in CurrentFolder.Split("/").Where(s => !string.IsNullOrWhiteSpace(s)))
        {
            <i class="fas fa-chevron-right"></i>
            <AeButton class="light" @onclick="@(async () => await BreadcrumbClicked(folder))">@folder</AeButton>
        }
    </div>
    <div class="actions">
        @if (!VirtualDirectory.ContainsKey(SelectedItem))
        {
            <AeButton class="tool" @onclick="HandleDownload">
                <i class="fas fa-download"></i>
            </AeButton>
            <AeButton class="tool">
                <i class="fas fa-trash-alt"></i>
            </AeButton>
            <span class="tool-divider"></span>
        }
        <AeButton class="tool">
            <i class="fas fa-upload"></i>
        </AeButton>
        <AeButton class="tool">
            <i class="fas fa-folder-plus"></i>
        </AeButton>
    </div>
</div>

@code {

    [CascadingParameter(Name = "ProjectAcronym")]
    public string ProjectAcronym { get; set; }
    
    [Parameter]
    public string CurrentFolder { get; set; }
    
    [Parameter]
    public string SelectedItem { get; set; }
    
    [Parameter]
    public Dictionary<string, List<FileMetaData>> VirtualDirectory { get; set; }

    [Parameter]
    public EventCallback<string> SetCurrentFolder { get; set; }

    private async Task BreadcrumbClicked(string breadcrumb)
    {
        var index = CurrentFolder.IndexOf(breadcrumb, StringComparison.OrdinalIgnoreCase);
        await SetCurrentFolder.InvokeAsync(CurrentFolder[..(index + breadcrumb.Length)]);
    }

    private async Task HandleDownload()
    {
        var file = VirtualDirectory[CurrentFolder]?
            .FirstOrDefault(f => f.name == SelectedItem);

        if (file != null)
        {
            var uri = await _apiService.DownloadFile(file, ProjectAcronym);
            await _jsRuntime.InvokeVoidAsync("open", uri.ToString(), "_blank");
        }
    }

}
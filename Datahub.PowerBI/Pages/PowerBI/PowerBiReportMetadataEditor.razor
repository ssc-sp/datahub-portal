@using Datahub.Metadata.Model
@using Datahub.Portal.Metadata.Components;
@using Datahub.PowerBI.Data;
@inject IPowerBiDataService _powerBiDataService
@inject TranslationService _translationService
@inject IMetadataBrokerService _metadataService
@inject IDbContextFactory<DatahubProjectDBContext> _projectDbFactory

@if (_report == null)
{
    <Spinner />
}
else
{
    <MudStack>
        <MudText Typo="Typo.h6">@Localizer["Catalog"]</MudText>

        <div>
            <label>
                <input type="checkbox" @bind=@_includeInCatalog />
                <AeTypography style="display: inline-block;"><strong><span>@Localizer[$"{LOCALIZATION_PREFIX}.IncludeInCatalog"]</span></strong></AeTypography>
            </label>
        </div>

        <div style="margin-top: 0.5rem; width: 100%">
            <AeTypography><strong><span>@Localizer[$"Language"]</span></strong></AeTypography>
            <select class="ae input" @bind="_catalogObjectLanguage" disabled=@NotIncludedCurrentItemInCatalog>
                <option value=@CatalogObjectLanguage.Bilingual>@Localizer["Bilingual"]</option>
                <option value=@CatalogObjectLanguage.English>@Localizer["English"]</option>
                <option value=@CatalogObjectLanguage.French>@Localizer["French"]</option>
            </select>
        </div>

        @if (_siblingReports.Count > 0)
        {
            <div style="margin-top: 0.5rem; width: 100%">
                <AeFlex Vertical>
                    <AeTypography><strong><span>@Localizer[$"Grouped with"]</span></strong></AeTypography>
                    <select @bind="_groupWithId" class="ae input" disabled=@NotIncludedCurrentItemInCatalog>
                        <option value=""></option>
                        @foreach (var report in _siblingReports)
                        {
                            <option value="@report.Report_ID.ToString()">@report.Report_Name</option>
                        }
                    </select>
                </AeFlex>
            </div>
        }
    </MudStack>

    @*metadata*@
    <MudStack>
        <MudText Typo="Typo.h6">@Localizer[$"{LOCALIZATION_PREFIX}.Metadata"]</MudText>
        <ObjectMetadataEditor @ref=@_reportMetadata
                          ObjectId=@PowerBiReportId.ToString()
                          Location="PowerBI"
                          ProfileName="catalog"
                          ObjectType=@Metadata.Model.MetadataObjectType.PowerBIReport
                          UpdateCatalog=@_includeInCatalog
                          ValidateRequired
                          Name=@_report.Report_Name
                          HideSaveButton
                          CatalogLanguage=@_catalogObjectLanguage
                          OnValuesChanged=@(() => StateHasChanged())
                          DefaultMetadataId=@ProjectAcronym
                          ProjectId=@_projectId
                          OnNewMetadataCreated=@AutoFillNewMetadataFields
                          OnExistingMetadataLoaded=@DetectIfCurrentItemIsInCatalog />

        <div style="margin-top: 1rem;">
            <AeButton OnClickEvent=@SaveReport Disabled=@SaveReportDisabled>@Localizer[$"BUTTONS.Save"]</AeButton>
            <AeButton class="light" OnClickEvent=@CancelEditing>@Localizer[$"BUTTONS.Cancel"]</AeButton>
            <SuccessIndicator @bind-IsLoading=@_isSavingReport @ref=@_saveReportInd />
        </div>
    </MudStack>
}

@code {

    private static string LOCALIZATION_PREFIX = $"{PowerBiManagementConstants.POWERBI_MANAGEMENT_LOCALIZATION_ROOT_KEY}.POWER_BI_ADMIN";

    [Parameter]
    public Guid PowerBiReportId { get; set; }

    [Parameter]
    public string ProjectAcronym { get; set; }

    [Parameter]
    public EventCallback<bool> OnCloseDialog { get; set; }

    private PowerBi_Report _report;
    private List<PowerBi_Report> _siblingReports;
    private string _groupWithId;

    private ObjectMetadataEditor _reportMetadata;
    private int _projectId;

    private bool _isSavingReport;
    private bool SaveReportDisabled => _isSavingReport || (_reportMetadata?.SaveDisabled ?? false);
    private SuccessIndicator _saveReportInd;

    private bool _includeInCatalog = true;
    private CatalogObjectLanguage _catalogObjectLanguage;

    private bool NotIncludedCurrentItemInCatalog => !_includeInCatalog;


    private async Task AutoFillNewMetadataFields()
    {
        if (_reportMetadata == null)
        {
            return;
        }

        var currentTitle = _report.Report_Name;
        if (string.IsNullOrEmpty(currentTitle))
        {
            return;
        }

        var titleFr = await _translationService.GetFrenchTranslation(currentTitle);

        _reportMetadata.SetValue(PowerBiManagementConstants.TITLE_EN_METADATA_FIELD, currentTitle);
        _reportMetadata.SetValue(PowerBiManagementConstants.TITLE_FR_METADATA_FIELD, titleFr);

        var currentProjectId = _report.Workspace.Project_Id;
        if (currentProjectId.HasValue)
        {
            var projectAdmins = "TODO";
            //var projectAdmins = GetProjectAdmins(currentProjectId.Value);
            _reportMetadata.SetValue(PowerBiManagementConstants.CONTACT_INFO_METADATA_FIELD, projectAdmins);
        }

        await Task.CompletedTask;
    }

    private async Task DetectIfCurrentItemIsInCatalog()
    {
        if (_reportMetadata == null)
        {
            // reset boolean to default, just in case
            _includeInCatalog = true;
            return;
        }

        _includeInCatalog = await _metadataService.IsObjectCatalogued(_reportMetadata.ObjectId);
    }

    private async Task SaveReport()
    {
        if (_report == null)
        {
            await Task.CompletedTask;
            return;
        }

        _isSavingReport = true;
        StateHasChanged();

        var success = await _reportMetadata.SaveChanges();

        if (success)
        {
            if (_includeInCatalog)
            {
                // group the report
                if (!string.IsNullOrEmpty(_groupWithId))
                {
                    var group = new List<string> { PowerBiReportId.ToString(), _groupWithId };
                    await _metadataService.GroupCatalogObjects(group);
                }
            }
            else
            {
                // todo: ungroup the report
                await _metadataService.DeleteFromCatalog(_reportMetadata.ObjectId);
            }
            // update the in catalog flag
            await _powerBiDataService.UpdateReportCatalogStatus(PowerBiReportId, _includeInCatalog);
        }

        if (success)
        {
            await _saveReportInd.SignalSuccess();
            await CloseItemBeingEdited(true);
        }
        else
        {
            await _saveReportInd.SignalFailure();
        }
    }

    private async Task CancelEditing() => await CloseItemBeingEdited(false);

    private async Task CloseItemBeingEdited(bool isSaved)
    {
        if (OnCloseDialog.HasDelegate)
        {
            await OnCloseDialog.InvokeAsync(isSaved);
        }
    }

    private async Task<List<PowerBi_Report>> GetReportsForGrouping(PowerBi_Report report)
    {
        var siblings = await _powerBiDataService.GetWorkspaceReports(report.Workspace_Id);
        return siblings.Where(r => r.InCatalog && r.Report_ID != report.Report_ID).ToList();
    }

    private async Task<string> GetGroupedWith(PowerBi_Report report)
    {
        var reportId = report.Report_ID.ToString().ToLower();
        var group = await _metadataService.GetObjectCatalogGroup(reportId);
        return group.FirstOrDefault(id => !id.Equals(reportId, StringComparison.OrdinalIgnoreCase));
    }


    protected override async Task OnParametersSetAsync()
    {
        _report = await _powerBiDataService.GetReportById(PowerBiReportId, true);
        _siblingReports = await GetReportsForGrouping(_report);
        _groupWithId = await GetGroupedWith(_report);
        _catalogObjectLanguage = await _metadataService.GetCatalogObjectLanguage(PowerBiReportId.ToString()) ?? CatalogObjectLanguage.Bilingual;
    }

    protected override async Task OnInitializedAsync()
    {
        var ctx = await _projectDbFactory.CreateDbContextAsync();
        var project = await ctx.Projects.FirstOrDefaultAsync(p => p.Project_Acronym_CD == ProjectAcronym);
        _projectId = project?.Project_ID ?? 0;
    }

}

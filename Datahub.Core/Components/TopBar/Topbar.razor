@inject UIControlsService UI
@inject IUserInformationService UserInformationService
@inject NavigationManager NavigationManager
@inject MyDataService _myDataService
@inject IPortalVersionService VersionService
@inject MicrosoftIdentityConsentAndConditionalAccessHandler ConsentHandler

@using Microsoft.Identity.Web
@using Datahub.Core.Components.Common

<MudStack Row AlignItems="AlignItems.Center" Class="ml-4">
    <MudImage src="_content/Datahub.Core/img/datahub-logo-v2.png" Alt="datahub logo" Height="40"/>
    <MudText Typo="Typo.h6" Color="Color.Dark">
        <b>Data Hub</b>
    </MudText>
</MudStack>
<MudSpacer/>
<Search/>
<MudSpacer/>

<NotificationsList/>
<HelpPopup />


<div class="profile">
    <AuthorizeView>
        <MudButton>
            <MudText>@UserName</MudText>
            <ProfileCircle FullName="@UserName" style="margin-left: 1rem"/>
            <MudIcon Icon="@Icons.Filled.ArrowDropDown" />
        </MudButton>
        <div class="toggle" @onclick="ToggleUserPopup">
            <Typography>@UserName</Typography>
            <i class="fal fa-chevron-down" style="padding-left: 0.75rem;"></i>
        </div>
        <Popup Show="_showUserPopup" class="nrcan-popup top-nav-popup user-popup" OnCloseClick="ToggleUserPopup">
            <ChildContent>
                <div class="user-section">
                    <ProfileCircle FullName="@UserName"/>
                    <div class="details">
                        <Typography class="username">@UserName</Typography>
                        <Typography class="email">@Email</Typography>
                    </div>
                    <div class="language-toggle">
                        <Typography Variant="b">
                            <LanguageToggle/>
                        </Typography>
                    </div>
                </div>
                <Typography class="description">@Localizer.GetString("You have used {0} of your allocated {1}", DatahubTools.BytesToString(TotalSpaceUsed), MaxAllocatedSpace)</Typography>
            </ChildContent>
            <Footer>
                <Typography class="signout">
                    <a href="MicrosoftIdentity/Account/SignOut">
                        <b>@Localizer["Sign Out"]</b>
                    </a>
                </Typography>
            </Footer>
        </Popup>
    </AuthorizeView>
</div>

@code
{

    public Microsoft.Graph.User User { get; set; }

    private string UserName
    {
        get { return User != null ? User.DisplayName : "..."; }
    }

    private string Email
    {
        get { return User != null ? User.UserPrincipalName : "..."; }
    }

    private string UserId
    {
        get { return User != null ? User.Id : "..."; }
    }

    private bool _showHelp = false;
    private bool _showUserPopup = false;

    public string MaxAllocatedSpace = "10GB";

    public long TotalSpaceUsed { get; set; } = 0;

    protected override void OnInitialized()
    {
        UI.OnRightSidebarChange += StateHasChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            User = await UserInformationService.GetUserAsync();
        }
        catch (Exception ex)
        {
            ConsentHandler.HandleException(ex);
        }
    }

    private void ToggleHelp()
    {
        _showHelp = !_showHelp;
        _showUserPopup = false;
        StateHasChanged();
    }

    private async void ToggleUserPopup()
    {
        _showUserPopup = !_showUserPopup;
        if (_showUserPopup)
        {
            TotalSpaceUsed = await _myDataService.GetUserUsedDataTotal(User);
        }
        _showHelp = false;
        StateHasChanged();
    }

    private void ToggleNotifications()
    {
        _showUserPopup = false;
        _showHelp = false;
        UI.ToggleRightSidebar(@<Datahub.Core.Views.Notifications/>);
    }

    private void NavigateToTermsOfUse()
    {
        NavigationManager.NavigateTo("termsandconditions");
    }

    private void NavigateToPrivacyStatement()
    {
        NavigationManager.NavigateTo("privacystatement");
    }
}
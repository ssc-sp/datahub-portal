@using Datahub.Portal.Pages.Profile.Settings.Views
@using Datahub.Portal.Components.User

@inject IUserInformationService _userInformationService

@page "/profile/settings/{Section?}"

<MudContainer MaxWidth="MaxWidth.Large">
    <MudGrid>
        <MudItem xs="3">
            <MudStack Spacing="6" Style="position: sticky; top: calc(var(--mud-appbar-height) + 8px);">
                <UserCard ViewedUser="@_portalUser"/>
                <ProfileSettingsSidebar ViewedUser="@_portalUser"/>
            </MudStack>
        </MudItem>
        <MudItem xs="9" md="6">
            @if (_portalUser is null)
            {
                <DHLoadingInitializer Message="@Localizer["Loading Settings"]"/>
            }
            else
            {
                @switch (Section)
                {
                    case SectionViews.Appearance:
                        <ProfileSettingsAppearance ViewedUser="@_portalUser" OnViewedUserChanged="HandleViewedUserChanged"/>
                        break;
                    case SectionViews.EmailPreferences:
                        <ProfileSettingsEmailPreferences/>
                        break;
                    case SectionViews.ProfileDisplay:
                        <ProfileSettingsDisplay ViewedUser="@_portalUser" OnViewedUserChanged="HandleViewedUserChanged"/>
                        break;
                    default:
                        <ProfileSettingsDisplay ViewedUser="@_portalUser" OnViewedUserChanged="HandleViewedUserChanged"/> // redundant, but just in case
                        break;
                }
            }
        </MudItem>
    </MudGrid>
</MudContainer>

@code {

    [Parameter]
    public string Section { get; set; }

    private PortalUser _portalUser;

    public struct SectionViews
    {
        public const string ProfileDisplay = "display";
        public const string Appearance = "appearance";
        public const string EmailPreferences = "email";
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var graphUser = await _userInformationService.GetCurrentGraphUserAsync();
        var language = await _userInformationService.GetUserLanguage();

        _portalUser = new PortalUser
        {
            GraphGuid = graphUser.Id,
            DisplayName = graphUser.DisplayName,
            Email = graphUser.Mail,
            Language = language
        };
    }

    private async Task HandleViewedUserChanged(PortalUser updatedUser)
    {
        _portalUser = updatedUser;
        await InvokeAsync(StateHasChanged);
    }

}
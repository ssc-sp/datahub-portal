@using Datahub.Portal.Pages.Profile.Settings.Views
@using Datahub.Portal.Components.User
@using Datahub.Core.Model.Achievements

@inject IUserInformationService _userInformationService

@page "/profile/achievements"

<MudContainer MaxWidth="MaxWidth.Large">
    <MudStack Spacing="6">
        <UserCard ViewedUser="@_viewedPortalUser"/>
        <MudStack>
            <MudText Typo="Typo.h3" Class="mb-4">
                @Localizer["Achievements"]
            </MudText>

            @foreach (var userAchievement in GetUserAchievements())
            {
                <AchievementListItem UserAchievement="@userAchievement"/>
                <MudDivider/>
            }
            
            @foreach (var achievement in GetUnEaredUserAchievements())
            {
                <AchievementListItem Achievement="@achievement"/>
                <MudDivider/>
            }
        </MudStack>
    </MudStack>
</MudContainer>

@code {

    [Parameter]
    public string Section { get; set; }

    private PortalUser _viewedPortalUser;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _viewedPortalUser = await _userInformationService.GetCurrentPortalUserWithAchievementsAsync();
    }


    private IEnumerable<UserAchievement> GetUserAchievements()
    {
        return _viewedPortalUser?.Achievements?
            .OrderBy(a => a.Achievement.Id)
            .ThenBy(a => a.UnlockedAt)
            .ToList()
               ?? new List<UserAchievement>();
    }
    
    private IEnumerable<Achievement> GetUnEaredUserAchievements()
    {
        return Achievement.GetAll()
            .Where(a => _viewedPortalUser?.Achievements?.All(ua => ua.Achievement.Id != a.Id) ?? false)
            .OrderBy(a => a.Id)
            .ToList();
    }

}
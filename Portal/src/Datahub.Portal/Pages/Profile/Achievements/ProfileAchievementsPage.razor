@using Datahub.Portal.Pages.Profile.Settings.Views
@using Datahub.Portal.Components.User
@using Datahub.Core.Model.Achievements

@inject IUserInformationService _userInformationService
@inject IDbContextFactory<DatahubProjectDBContext> _contextFactory;

@page "/profile/achievements"

<MudContainer MaxWidth="MaxWidth.Large">
    <MudStack Spacing="6">
        <UserCard ViewedUser="@_viewedPortalUser"/>
        <MudStack>
            <MudText Typo="Typo.h3" Class="mb-4">
                @Localizer["Achievements"]
            </MudText>

            @foreach (var userAchievement in GetUserAchievements())
            {
                var rarity = GetRarity(userAchievement);
                <AchievementListItem UserAchievement="@userAchievement" Rarity="@rarity"/>
                <MudDivider/>
            }
            
            @foreach (var achievement in GetUnEaredUserAchievements())
            {
                var rarity = GetRarity(achievement);
                <AchievementListItem Achievement="@achievement" Rarity="@rarity"/>
                <MudDivider/>
            }
        </MudStack>
    </MudStack>
</MudContainer>

@code {

    [Parameter]
    public string Section { get; set; }

    private PortalUser _viewedPortalUser;

    private Dictionary<string, int> _achievementRarityDictionary;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _viewedPortalUser = await _userInformationService.GetCurrentPortalUserWithAchievementsAsync();
        _achievementRarityDictionary = await FetchAchievementRarities();
    }

    private async Task<Dictionary<string,int>> FetchAchievementRarities()
    {
        await using var context = await _contextFactory.CreateDbContextAsync();
        
        // get the total number of users
        var totalUsers = await context.PortalUsers
            .CountAsync();
        
        // get the number of users who have each achievement
        var achievementCounts = await context.UserAchievements
            .GroupBy(ua => ua.AchievementId)
            .Select(g => new
            {
                AchievementId = g.Key,
                Count = g.Count()
            })
            .ToListAsync();
        
        // get the number of users who have each achievement to a dictionary
        var achievementRarityDictionary = achievementCounts
            .ToDictionary(
                ac => ac.AchievementId,
                ac => (int) Math.Round((double) ac.Count / totalUsers * 100)
            );
        
        return achievementRarityDictionary;
    }

    private int GetRarity(UserAchievement userAchievement)
    {
        return GetRarity(userAchievement.Achievement);
    }
    
    private int GetRarity(Achievement achievement)
    {
        return _achievementRarityDictionary.TryGetValue(achievement.Id, out var value) ? value : 0;
    }


    private IEnumerable<UserAchievement> GetUserAchievements()
    {
        return _viewedPortalUser?.Achievements?
            .OrderBy(a => a.Achievement.Id)
            .ThenBy(a => a.UnlockedAt)
            .ToList()
               ?? new List<UserAchievement>();
    }
    
    private IEnumerable<Achievement> GetUnEaredUserAchievements()
    {
        return Achievement.GetAll()
            .Where(a => _viewedPortalUser?.Achievements?.All(ua => ua.Achievement.Id != a.Id) ?? false)
            .OrderBy(a => a.Id)
            .ToList();
    }

}
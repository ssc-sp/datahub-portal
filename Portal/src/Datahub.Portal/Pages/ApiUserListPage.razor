@page "/apiusers"
@using Datahub.Core.Model.Projects
@using Datahub.Infrastructure.Services.Security
@using Datahub.Application.Services.Security

@inject ServiceAuthManager ServiceAuthManager
@inject IUserInformationService _userInformationService
@inject IDbContextFactory<DatahubProjectDBContext> ContextFactory
@inject IKeyVaultService _keyVaultService
@inject IJSRuntime JsInterop

<DHPageTitle PageTitleKey="API Users" />

<AuthorizeView Roles="@string.Join(',', _authorizedRoles)">
    <Authorized>
        <div style="margin: 2rem">
            <AeTypography Variant="h2">API Users</AeTypography>
            <AeCard>
                <ChildContent>
                    <div>
                        <Typography Variant="h3">Clients</Typography>
                        <AeTable 
                            T=@DatahubProjectApiUser
                            Accessors=@_accessorFunctions
                            Dataset=@_apiUsers
                            Headers=@_headers
                            Renderers=@_renderFunctions
                            GridTemplateColumns="2fr 2fr 4fr 2fr 2fr 2fr"
                        />
                        @if (_newClient is null)
                        {
                            <div style="margin-top: 16px;">
                                <AeButton OnClickEvent=@HandleAddNewClient>Add Client</AeButton>
                            </div>
                        }
                    </div>

                    @if (_newClient is not null)
                    {
                        <div>
                            <AeModelForm 
                                Model=@_newClient
                                T=@DatahubProjectApiUser
                                OnValidSubmit=@HandleSubmitNewClient
                                OnCancel=@HandleCancelNewClient
                                CancelLabel="Cancel"
                            />
                        </div>
                    }
                </ChildContent>
            </AeCard>
        </div>
    </Authorized>
    <NotAuthorized>
        "You are not authorized."
    </NotAuthorized>
</AuthorizeView>


@code {

    private List<string> _authorizedRoles = new();
    private List<DatahubProjectApiUser> _apiUsers;

    private List<string> _headers = new();
    private List<Func<DatahubProjectApiUser, RenderFragment>> _renderFunctions = new();
    private List<Func<DatahubProjectApiUser, string>> _accessorFunctions = new();

    private DatahubProjectApiUser _newClient;

    protected override async Task OnInitializedAsync()
    {
        
        var user = await _userInformationService.GetCurrentGraphUserAsync();
        _authorizedRoles = ServiceAuthManager.GetAdminProjectRoles(user.Id);

        using var ctx = ContextFactory.CreateDbContext();
        _apiUsers = await ctx.ProjectApiUsers.ToListAsync();

        _headers = new() { "Client", "Project", "Email", "Expiration", "Active", "Token" };
        _accessorFunctions = new() { GetClient, GetProject, GetEmail, GetExpiration, GetActive, null };
        _renderFunctions = new() { null, null, null, null, null, GetActions }; 
    }

    private string GetClient(DatahubProjectApiUser row) => row.ClientNameTXT;
    private string GetProject(DatahubProjectApiUser row) => row.ProjectAcronymCD;
    private string GetEmail(DatahubProjectApiUser row) => row.EmailContactTXT;
    private string GetExpiration(DatahubProjectApiUser row) => row.ExpirationDT.HasValue ? row.ExpirationDT.Value.ToShortDateString() : "Never";
    private string GetActive(DatahubProjectApiUser row) => row.Enabled ? "Yes" : "No";

    private string GetToken(DatahubProjectApiUser row) => "";

    private RenderFragment GetActions(DatahubProjectApiUser row)
    {
        return @<i class="fas fa-copy" style="cursor: pointer;" @onclick="() => CopyTokenToClipboad(row)" title="Copy to clipboard"></i>
    ;
    }

    private void HandleAddNewClient()
    {
        _newClient = new() { Enabled = true };
    }

    private async Task HandleSubmitNewClient()
    {
        using var ctx = ContextFactory.CreateDbContext();
        ctx.ProjectApiUsers.Add(_newClient);
        await ctx.SaveChangesAsync();
        _apiUsers.Add(_newClient);
        _newClient = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task<DatahubProjectApiUser> HandleCancelNewClient()
    {
        _newClient = null;
        await InvokeAsync(StateHasChanged);
        return _newClient;
    }    

    private async Task CopyTokenToClipboad(DatahubProjectApiUser row)
    {
        var token = await _keyVaultService.EncryptApiTokenAsync(row.ProjectApiUserID.ToString());
        await JsInterop.InvokeAsync<string>("copyTextToClipboard", token);
    }
}

@page "/w/{ProjectAcronymParam}"

@using Datahub.Core.Model.UserTracking;
@using Datahub.Portal.Pages.Project.DataProject.ProjectTools
@using Datahub.Core.Components.PageBanner
@using Datahub.Core.Services.Achievements
@using Datahub.Core.Model.Achievements
@using Datahub.Core.Model.Projects
@using Datahub.Application.Services

@inject IDbContextFactory<DatahubProjectDBContext> _dbFactoryProject
@inject IUserInformationService _userInformationService
@inject IPortalUserTelemetryService _telemetryService
@inject IDatahubAuditingService _auditingService
@inject UserLocationManagerService _userLocationManagerService
@inject ILogger<DataProjectPage> _logger
@inject DatahubPortalConfiguration Configuration
@inject IDialogService _dialogService
@inject IResourceMessagingService _resourceMessagingService
@inject ISnackbar _snackbar


<DHPageAlert
    Title=@Localizer["Welcome to your Workspace"]
    Key="@PageAlert.ProjectFeatures"
    WikiLinkEN="/Banners/Workspace"
    WikiLinkFR="/fr/Banners/Espace-de-travail"/>

<DHPageTitle PageTitleKey="@_projectName"/>

@if (_project is not null)
{
    <MudGrid>
        <CascadingValue Value=@ProjectAcronymParam Name="ProjectAcronym">
            <MudItem sm="12" md="7" lg="8">
                <ProjectInfo ProjectAcronym="@ProjectAcronymParam"/>
                @if (_clientEngagements.Any())
                {
                    <ProjectEngagements/>
                }
                <ProjectCatalog IsFrench="@_isFrench"/>
                <ProjectToolListing/>
            </MudItem>
            <MudItem sm="12" md="5" lg="4">
                <ProjectUserCardList ProjectAcronym="@ProjectAcronymParam"/>
            </MudItem>

            @if (ReverseProxyEnabled)
            {
                <MudItem sm="12">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudIcon Icon="@Icons.Material.Filled.Web" />
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h5">@Localizer["Web Application"]</MudText>
                            </CardHeaderContent>                            
                        </MudCardHeader>
                        <MudCardContent>
                            <DatahubAuthView AuthLevel="DatahubAuthView.AuthLevels.WorkspaceAdmin" ProjectAcronym="@ProjectAcronymParam">
                                <MudStack>
                                    <MudSwitch T="bool"
                                               CheckedChanged="HandleCheckedChanged"
                                               Checked="WebAppEnabled"
                                               Label="Enabled"
                                               Color="Color.Info" />
                                    <MudTextField @bind-Value="@_project.WebApp_URL" 
                                                  T="string" 
                                                  Label="URL" 
                                                  HelperText=@Localizer["Note: It takes up to 5 minutes for the reverse proxy to take your changes."]
                                                  Variant="Variant.Outlined" />
                                </MudStack>
                            </DatahubAuthView>
                        </MudCardContent>
                        <MudCardActions>
                            <DatahubAuthView AuthLevel="DatahubAuthView.AuthLevels.WorkspaceAdmin" ProjectAcronym="@ProjectAcronymParam">
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           EndIcon="@Icons.Material.Filled.Save"
                                           Disabled="WebAppSaveDisabled"
                                           OnClick=@HandleSaveChanges>
                                    @Localizer["Save"]
                                </MudButton>
                            </DatahubAuthView>
                            <MudButton Href=@GetAppUrl() 
                                       Target=@ProjectAcronymParam 
                                       Variant="Variant.Text" 
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       Class="ml-4"
                                       EndIcon="@Icons.Material.Filled.KeyboardDoubleArrowRight"
                                       Disabled="!WebAppEnabled">
                                @Localizer["Visit"]
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
            <DatahubAuthView AuthLevel="DatahubAuthView.AuthLevels.WorkspaceLead">
                <MudButton Variant="Variant.Text"
                           Color="Color.Error"
                           EndIcon="@Icons.Material.Filled.Delete"
                           OnClick="OpenDeletionDialog">
                    @Localizer["Delete Workspace"]
                </MudButton>
            </DatahubAuthView>
        </CascadingValue>
    </MudGrid>
}

@code {

    [Parameter]
    public string ProjectAcronymParam { get; set; }

    private Datahub_Project _project;
    private string _userId;
    private string _projectName;
    private bool _isFrench;
    private string _wsAppBase;
    private List<Client_Engagement> _clientEngagements = new();

    private bool ReverseProxyEnabled => Configuration.ReverseProxy.Enabled;

    protected override async Task OnInitializedAsync()
    {
        await using var projectContext = await _dbFactoryProject.CreateDbContextAsync();

        _project = await projectContext.Projects
            .AsNoTracking()
            .Include(p => p.ServiceRequests)
            .Include(p => p.Pipelines)
            .Include(p => p.Whitelist)
            .Where(p => p.Project_Acronym_CD == ProjectAcronymParam)
            .FirstOrDefaultAsync();

        if (_project is null)
            return;

        _isFrench = Thread.CurrentThread.CurrentCulture.Name.Equals("fr-ca", StringComparison.OrdinalIgnoreCase);
        _projectName = _project?.ProjectName;

        _userId = await _userInformationService.GetUserIdString();
        if (_userId is null) _logger.LogError("UserId is null");

        var isMemberOfProject = projectContext.Project_Users
            .Any(p => p.User_ID == _userId && p.Project.Project_Acronym_CD == ProjectAcronymParam);

        if (isMemberOfProject)
        {
            await _telemetryService.LogTelemetryEvent(TelemetryEvents.UserViewProject);
        }
        else
        {
            await _telemetryService.LogTelemetryEvent(TelemetryEvents.UserViewProjectNotMemberOf);
        }

        _clientEngagements = await projectContext.Client_Engagements.Where(ce => ce.Project == _project && ce.Is_Engagement_Active).ToListAsync();
        await _auditingService.TrackEvent("Open Initiative", ("Initiative", _projectName), ("Acronym", ProjectAcronymParam));

        // record recent link
        await RecordRecentLink();

        // initialize the shiny web app url
        if (_project.WebAppEnabled != true && string.IsNullOrWhiteSpace(_project.WebApp_URL))
        {
            _project.WebApp_URL = GetDefaultAppUrl();
        }        
    }

    private bool WebAppEnabled => ReverseProxyEnabled && _project?.WebAppEnabled == true;
    private bool WebAppSaveDisabled => WebAppEnabled && string.IsNullOrWhiteSpace(_project?.WebApp_URL);

    private async Task RecordRecentLink()
    {
        if (string.IsNullOrEmpty(ProjectAcronymParam))
            return;

        var userRecentLink = new UserRecentLink()
        {
            LinkType = DatahubLinkType.DataProject,
            DataProject = ProjectAcronymParam,
            accessedTime = DateTimeOffset.Now
        };

        await _userLocationManagerService.RegisterNavigation(userRecentLink);
    }

    private async Task HandleSaveChanges()
    {
        await using var ctx = await _dbFactoryProject.CreateDbContextAsync();

        var project = await ctx.Projects
            .Where(p => p.Project_Acronym_CD == ProjectAcronymParam)
            .FirstOrDefaultAsync();

        project.WebAppEnabled = _project.WebAppEnabled;
        project.WebApp_URL = _project.WebApp_URL;

        await ctx.SaveChangesAsync();
    }

    private async Task HandleCheckedChanged(bool value)
    {
        _project.WebApp_URL ??= GetDefaultAppUrl();
        _project.WebAppEnabled = value;
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task OpenDeletionDialog()
    {
        var parameters = new DialogParameters
        {
            { "ProjectAcronym", ProjectAcronymParam },
            { "ProjectName", _projectName }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true};

        var dialog = _dialogService.Show<DeleteProjectDialog>("Delete Workspace", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                var workspaceDefinition = await _resourceMessagingService.GetWorkspaceDefinition(ProjectAcronymParam);
                await _resourceMessagingService.SendToTerraformDeleteQueue(workspaceDefinition);
            }
            catch (Exception e)
            {
                _logger.LogError(e.Message);
                _snackbar.Add("Error deleting workspace", Severity.Error);
            }
            finally
            {
                _snackbar.Add("Workspace succesfully queued for deletion", Severity.Success);
            }
            
        }
    }

    private string GetAppUrl() => $"/{Configuration.ReverseProxy.BasePath}/{ProjectAcronymParam}/";

    private string GetDefaultAppUrl()
    {
        var appId = $"fsdh-proj-{_project.Project_Acronym_CD}-shiny-{Configuration.Hosting.EnvironmentName}".ToLower();
        return $"https://{appId}.azurewebsites.net";
    }
}
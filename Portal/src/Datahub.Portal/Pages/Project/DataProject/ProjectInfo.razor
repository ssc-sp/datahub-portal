@*ProjectInfo.razor*@

@using Datahub.Core.Components.Skeleton
@using Datahub.Core.Enums
@using Datahub.Core.Model.Datahub
@using Datahub.Core.Services.Metadata;
@using Datahub.Metadata.DTO
@using Datahub.Infrastructure.Services.Projects;
@using Datahub.Infrastructure.Services.Azure

@inject UIControlsService _uiControlService
@inject NavigationManager NavigationManager
@inject IMetadataBrokerService MetadataBrokerService
@inject MonthlyUsageService monthlyUsageService


@if (_loading)
{
    <Skeleton Height="2.5rem" Width="150px"/>
    <Skeleton Height="2.5rem" Width="150px"/>
    <Skeleton Height="5rem" Width="650px"/>
    <Skeleton Height="2rem" Width="900px"/>
    <Skeleton Height="2rem" Width="900px"/>
    <Skeleton Height="2rem" Width="300px"/>
    return;
}

<MudStack Row>
    <MudChip Label Color="@Color.Dark" class="project-data-sensitivity">@Localizer[Project.Data_Sensitivity]</MudChip>

    @if (_monthlyUsage is not null && _projectBudget > 0)
    {
        <MudBadge Icon="@Icons.Material.Filled.QuestionMark" Color="@GetCostChipColor()" Overlap="@true" Bordered="@true">
            <MudChip Label="true" Icon="@Icons.Material.Filled.AttachMoney" IconColor="@GetCostChipColor()" Variant="@Variant.Text"
                     Color="@GetCostChipColor()" class="project-data-sensitivity" OnClick=@HandleToggleCosts>
                @($"{CurrentProjectMonthlyCost:C} {Localizer["Azure cost for current month"]}")
            </MudChip>
        </MudBadge>
    }

    @if (IsProjectAdmin || IsDatahubAdmin)
    {
        var color = Project?.MetadataAdded ?? false ? Color.Default : Color.Warning;
        var icon = Project?.MetadataAdded ?? false ? Icons.Material.Filled.Edit : Icons.Material.Filled.Warning;
        <MudChip Icon="@icon"
                 IconColor="@color"
                 Variant="@Variant.Text"
                 Color="@color"
                 class="project-data-sensitivity"
                 OnClick="@HandleEditMetadata"
                 Label
                 >
            @Localizer["Edit Metadata"]
        </MudChip>
    }
</MudStack>

<MudStack>
    <MudText Typo="Typo.h1">
        <MudIcon Icon="@_projectIcon" Title="@Localizer["Project Icon"]"/>
        @Project.ProjectName
    </MudText>

    @if (Project.Project_Phase == TerraformOutputStatus.PendingApproval)
    {
        <MudAlert Severity="Severity.Warning">@Localizer["The project is currently pending approval. No resources can be provisioned until the project is approved by a Datahub Administrator"]</MudAlert>
    }
    @if (Project?.MetadataAdded != true)
    {
        <MudAlert Severity="Severity.Warning">@Localizer["The project's metadata is currently incomplete. No resources can be provisioned until the project metadata has been filled"]</MudAlert>
    }

    <DHMarkdown class="description" Content=@GetProjectDescription()/>
</MudStack>


@code {

    [CascadingParameter(Name = "Project")]
    private Datahub_Project Project { get; set; }

    [CascadingParameter(Name = "IsProjectAdmin")]
    private bool IsProjectAdmin { get; set; }

    [CascadingParameter(Name = "IsDatahubAdmin")]
    private bool IsDatahubAdmin { get; set; }

    private Project_MonthlyUsage _monthlyUsage = default;

    private decimal CurrentProjectMonthlyCost => Convert.ToDecimal(_monthlyUsage.CurrentCost);

    private decimal _projectBudget;
    private bool _loading = true;
    private FieldValueContainer _projectMetadata;

    private string ProjectAcronym => Project?.Project_Acronym_CD;
    private string _projectIcon => $"fas fa-{Project?.Project_Icon ?? Icon.DEFAULT_PROJECT_ICON}";


    protected override async Task OnInitializedAsync()
    {
        _monthlyUsage = await monthlyUsageService.GetProjectMonthlyUsage(Project.Project_ID, default);

        _projectBudget = Project.Project_Budget ?? 0;
        _projectMetadata = await MetadataBrokerService.GetObjectMetadataValues(ProjectAcronym);

        _loading = false;
    }

    private Color GetCostChipColor()
    {
        if (CurrentProjectMonthlyCost < 0.01m)
            return Color.Dark;
        if (CurrentProjectMonthlyCost >= _projectBudget)
            return Color.Error;
        if (CurrentProjectMonthlyCost >= 0.75m * _projectBudget)
            return Color.Warning;
        return Color.Default;
    }

    private string GetToolTipText()
    {
        var projectName = $"{Project.ProjectName} ";
        if (CurrentProjectMonthlyCost >= _projectBudget)
            return projectName + Localizer["is over budget"];
        if (CurrentProjectMonthlyCost >= 0.75m * _projectBudget)
            return projectName + Localizer["is nearing budget"];
        return projectName + Localizer["is under budget"];
    }

    private Color GetProtectionColor() => (Project?.Data_Sensitivity ?? "").ToUpper() switch
    {
        "CLASSIFIED"  or
            "PROTECTED B" or
            "PROTECTED C" => Color.Secondary,
        "PROTECTED A" => Color.Error,
        _ => Color.Dark
    };

    private string GetProjectDataSensitivity()
    {
        return !string.IsNullOrWhiteSpace(Project?.Data_Sensitivity) ? Project.Data_Sensitivity : "Unclassified";
    }

    private void HandleToggleCosts(MouseEventArgs args)
    {
        RenderFragment fragment = 
            @<ProjectCosting 
                ProjectBudget=@_projectBudget 
                MonthyUsage="@_monthlyUsage"
            />;

        var thisMonth = DateTime.UtcNow.ToString("MMMM");
        _uiControlService.ShowDialog($"{Localizer["Cost analysis"]} ({thisMonth})", fragment);
    }

    private void HandleEditMetadata(MouseEventArgs args)
    {
        NavigationManager.NavigateTo($"/w/{Project.Project_Acronym_CD}/metadata");
    }

    private string GetProjectDescription()
    {
        var description = _projectMetadata.GetValue($"notes_translated_{CultureService.Culture}", null);
        return description ?? Project.ProjectDescription;
    }
}
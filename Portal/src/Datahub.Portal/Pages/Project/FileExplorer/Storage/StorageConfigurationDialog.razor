@* StorageConfigurationDialog.razor *@

<MudDialog>
    <DialogContent>
        <MudStack>
            <MudTextField @bind-Value=@CloudStorageSettings.Name Label=@Localizer["Name"] Variant=@Variant.Text />
            <MudCheckBox @bind-Checked=@CloudStorageSettings.Enabled >@Localizer["Enabled"]</MudCheckBox>
            @if (CloudProvider == CloudStorageProviderType.AWS)
            {
                <AWSConnectionDataInput @bind-ConnectionData=@ConnectionDataInternal OnValidationChanged=@HandleConnectionValidationChange />
            }
            else if (CloudProvider == CloudStorageProviderType.Azure)
            {
                <AzureConnectionDataInput @bind-ConnectionData=@ConnectionDataInternal OnValidationChanged=@HandleConnectionValidationChange />
            }
            else if (CloudProvider == CloudStorageProviderType.GCP)
            {
                <GCPConnectionDataInput @bind-ConnectionData=@CloudStorageSettings.ConnectionData OnValidationChanged=@HandleConnectionValidationChange />
            }
            <MudCheckBox @bind-Checked=@_isUnclassified>@Localizer["UnclassifiedDataConfirmation"]</MudCheckBox>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick=@HandleCancel Class="px-4">@Localizer["Cancel"]</MudButton>
        <MudButton Color="Color.Primary" OnClick="HandleSave" Disabled=@SaveDisabled Variant="Variant.Filled">
            @Localizer["Save"]
        </MudButton>
    </DialogActions>
</MudDialog>


@code {

    [CascadingParameter]
    public MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public CloudStorageProviderType CloudProvider { get; set; }

    [Parameter]
    public CloudStorageSettings CloudStorageSettings { get; set; }

    private string _initialConnectionData = string.Empty;
    private bool ConnectionDataChanged => !_initialConnectionData.Equals(ConnectionDataInternal);
    private string ConnectionDataInternal
    {
        get => CloudStorageSettings.ConnectionData;
        set
        {
            CloudStorageSettings.ConnectionData = value;
            if (ConnectionDataChanged)
            {
                _isUnclassified = false;
            }
        }
    }

    private bool _isConnectionValid = false;
    private bool _isUnclassified = false;

    private bool SaveDisabled => !(_isConnectionValid && _isUnclassified);

    private void HandleConnectionValidationChange(bool isValid)
    {
        _isConnectionValid = isValid;
    }

    private void HandleCancel() => MudDialog.Cancel();

    private void HandleSave()
    {
        MudDialog.Close(DialogResult.Ok(CloudStorageSettings));
    }

    protected override void OnInitialized()
    {
        _initialConnectionData = CloudStorageSettings?.ConnectionData ?? string.Empty;
        _isUnclassified = !string.IsNullOrEmpty(_initialConnectionData);
    }
}

@inject DatahubPortalConfiguration _portalConfiguration
@inject IKeyVaultService _keyVaultService

@using System.Net.Http;
@using System.Net.Http.Headers;
@using Newtonsoft.Json;
@using Newtonsoft.Json.Linq;

<MudStack Spacing="6">
    <MudText Typo="Typo.h1">@Localizer["Support Requests"]</MudText>
    <MudText Typo="Typo.body1">@Localizer["This page displays all the support requests submitted by the user."]</MudText>

    <MudText Typo="Typo.h2">@Localizer["Open Requests"]</MudText>
    <MudText Typo="Typo.body1">@Localizer["These are all open support requests. New requests may take up to 15 minutes to appear here."]</MudText>
    <MudTable Items="@_openIssues" Loading="@_loading" Hover Dense>
        <HeaderContent>
            <MudTh>@Localizer["Link to DevOps"]</MudTh>
            <MudTh>@Localizer["ID"]</MudTh>
			<MudTh>@Localizer["Title"]</MudTh>
			<MudTh>@Localizer["Description"]</MudTh>
            <MudTh>@Localizer["Status"]</MudTh>
            <MudTh>@Localizer["Submitted_DT"]</MudTh>
            <MudTh>@Localizer["Last Update"]</MudTh>
		</HeaderContent>
		<RowTemplate>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Outlined.Link" aria-label="share" Href="@GetIssueUrl(context.Id)"></MudIconButton>
            </MudTd>
            <MudTd>@context.Id</MudTd>
			<MudTd>@context.Title</MudTd>
            <MudTd>@TrimDescription(context.Description)</MudTd>
            <MudTd><MudChip Color="@GetColor(context.State)">@Localizer[context.Message]</MudChip></MudTd>
            <MudTd>@context.SubmittedDate</MudTd>
            <MudTd>@context.ChangedDate</MudTd>
		</RowTemplate>
        <PagerContent>
            <MudTablePager RowsPerPageString="@Localizer["Rows per page:"]" InfoFormat="@("{first_item}-{last_item} " + Localizer["of"] + " {all_items}")"/>
        </PagerContent>
    </MudTable>

    <MudText Typo="Typo.h2">@Localizer["Closed Requests"]</MudText>
    <MudText Typo="Typo.body1">@Localizer["These are all closed support requests."]</MudText>
	<MudTable Items="@_closedIssues" Loading="@_loading" Hover Dense>
		<HeaderContent>
			<MudTh>@Localizer["Link to DevOps"]</MudTh>
			<MudTh>@Localizer["ID"]</MudTh>
			<MudTh>@Localizer["Title"]</MudTh>
			<MudTh>@Localizer["Description"]</MudTh>
			<MudTh>@Localizer["Status"]</MudTh>
			<MudTh>@Localizer["Submitted_DT"]</MudTh>
			<MudTh>@Localizer["Last Update"]</MudTh>
		</HeaderContent>
		<RowTemplate>
			<MudTd>
				<MudIconButton Icon="@Icons.Material.Outlined.Link" aria-label="share" Href="@GetIssueUrl(context.Id)"></MudIconButton>
			</MudTd>
			<MudTd>@context.Id</MudTd>
			<MudTd>@context.Title</MudTd>
            <MudTd>@TrimDescription(context.Description)</MudTd>
			<MudTd><MudChip Color="@GetColor(context.State)">@Localizer[context.Message]</MudChip></MudTd>
			<MudTd>@context.SubmittedDate</MudTd>
			<MudTd>@context.ChangedDate</MudTd>
		</RowTemplate>
		<PagerContent>
			<MudTablePager RowsPerPageString="@Localizer["Rows per page:"]" InfoFormat="@("{first_item}-{last_item} " + Localizer["of"] + " {all_items}")"/>
		</PagerContent>
	</MudTable>
</MudStack>

@code {
    private List<IssueForDisplaying> _openIssues = new();
    private List<IssueForDisplaying> _closedIssues = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await GetIssues();
        StateHasChanged();
    }

    /**
     * Retrieves a list of issues created by a specific user.
     *
     * @param userName The username of the user.
     * @return A list of IssueForDisplaying objects representing the issues created by the user.
     */
    public async Task GetIssues()
    {
        _loading = true; // Show the loading bar in the table.
        _openIssues = new();
        _closedIssues = new();
        var query = $"SELECT [System.Id], [System.Title], [System.CreatedBy], [System.CreatedDate], [System.ChangedDate], [System.Tags] FROM WorkItems WHERE [System.Tags] CONTAINS 'UserSubmitted'";
        var apiUrl = $"https://dev.azure.com/{_portalConfiguration.AdoOrg.OrgName}/{_portalConfiguration.AdoOrg.ProjectName}/_apis/wit/wiql?api-version=7.0";

        using (var client = new HttpClient())
        {
            var credentials = await _keyVaultService.GetSecret(_portalConfiguration.AdoServiceUser.PatSecretName);
            client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Basic", Convert.ToBase64String(System.Text.Encoding.ASCII.GetBytes($":{credentials}")));

            // Create request body and send the POST request to Azure DevOps API
            var body = new JObject { ["query"] = query };
            var response = await client.PostAsync(apiUrl, new StringContent(body.ToString(), System.Text.Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();

            // Parse the response and extract the work item titles
            var jsonResponse = await response.Content.ReadAsStringAsync();
            var result = JObject.Parse(jsonResponse);

            // Collect all the titles
            var workItems = (JArray)result["workItems"];

            foreach (var workItem in workItems)
            {
                // Get the WorkItem ID
                var workItemId = (int)workItem["id"];
                // Get the WorkItem details with ID
                var itemApiUrl = $"https://dev.azure.com/{_portalConfiguration.AdoOrg.OrgName}/{_portalConfiguration.AdoOrg.ProjectName}/_apis/wit/workItems/{workItemId}?api-version=7.0";
                var workItemResponse = await client.GetAsync(itemApiUrl);
                workItemResponse.EnsureSuccessStatusCode();

                var workItemJsonResponse = await workItemResponse.Content.ReadAsStringAsync();
                var workItemDetails = JObject.Parse(workItemJsonResponse);

                // Retrieve fields that will be displayed to the user
                var issueId = (string)workItemDetails["id"];
                var title = (string)workItemDetails["fields"]["System.Title"];
                var description = (string)workItemDetails["fields"]["System.Description"];
                description = description.Split("<b>Description:</b> ")[1].Split("<br>")[0];
                var state = (string)workItemDetails["fields"]["System.State"];
                var submittedDate = (string)workItemDetails["fields"]["System.CreatedDate"];
                var changedDate = (string)workItemDetails["fields"]["System.ChangedDate"];

                string message = state;
                if (state == "Closed"){
                    _closedIssues.Add(new IssueForDisplaying(issueId, title, description, state, message, submittedDate, changedDate));
                }
                else {
                    _openIssues.Add(new IssueForDisplaying(issueId, title, description, state, message, submittedDate, changedDate));
                }
            }
        }
        _loading = false; // Stop showing the loading bar in the table.

        // Reverse the issues list so that the most recent issues are displayed first
        _openIssues.Reverse();
    }

    /**
     * Generates the URL for a specific issue in Azure DevOps.
     *
     * @param issueId The ID of the issue.
     * @return The URL for the issue in Azure DevOps.
     */
    private string GetIssueUrl(string issueId)
    {
        return $"https://dev.azure.com/{_portalConfiguration.AdoOrg.OrgName}/{_portalConfiguration.AdoOrg.ProjectName}/_workitems/edit/{issueId}";
    }

    /**
     * Trims the description to a specified maximum length and appends ellipsis if necessary.
     *
     * @param description The description to be trimmed.
     * @param maxLength The maximum length of the trimmed description.
     * @return The trimmed description.
     */
    private string TrimDescription(string description, int maxLength = 240)
    {
        if (description.Length > maxLength)
            return description.Substring(0, maxLength) + "...";
        else
            return description;
    }

    /**
     * Retrieves the color based on the status of an issue.
     *
     * @param status - The status of the issue.
     * @returns The color associated with the status.
     */
    private static Color GetColor(string status)
    {
        return status switch
        {
            "Closed" => Color.Success,
            "Active" => Color.Default,
            "New" => Color.Default,
            _ => Color.Default
        };
    }

    /**
     * Represents an issue for displaying in the support ticket table.
     */
    public class IssueForDisplaying
    {
        /// <summary>
        /// Gets or sets the ID of the issue.
        /// </summary>
        public string Id { get; set; }

        /// <summary>
        /// Gets or sets the title of the issue.
        /// </summary>
        public string Title { get; set; }

        /// <summary>
        /// Gets or sets the description of the issue.
        /// </summary>
        public string Description { get; set; }

        /// <summary>
        /// Gets or sets the state of the issue.
        /// </summary>
        public string State { get; set; }

        /// <summary>
        /// Gets or sets the message to display to the user based on the state of the issue.
        /// </summary>
        public string Message { get; set; }

        /// <summary>
        /// Gets or sets the date the issue was submitted.
        /// </summary>
        public string SubmittedDate { get; set; }

        /// <summary>
        /// Gets or sets the date the issue was last changed.
        /// </summary>
        public string ChangedDate { get; set; }

        /// <summary>
        /// Initializes a new instance of the <see cref="IssueForDisplaying"/> class.
        /// </summary>
        /// <param name="id">The ID of the issue.</param>
        /// <param name="title">The title of the issue.</param>
        /// <param name="description">The description of the issue.</param>
        /// <param name="state">The state of the issue.</param>
        /// <param name="message">The message to display to the user based on the state of the issue.</param>
        /// <param name="submittedDate">The date the issue was submitted.</param>
        /// <param name="changedDate">The date the issue was last changed.</param>
        public IssueForDisplaying(string id, string title, string description, string state, string message, string submittedDate, string changedDate)
        {
            Id = id;
            Title = title;
            Description = description;
            State = state;
            Message = message;
            SubmittedDate = submittedDate;
            ChangedDate = changedDate;
        }
    }
}

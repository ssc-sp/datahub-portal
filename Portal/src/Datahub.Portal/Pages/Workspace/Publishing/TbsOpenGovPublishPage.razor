@* TbsOpenGovPublishPage.razor *@

@using Datahub.Application.Services.Publishing;
@using Datahub.Core.Model.Achievements;
@using StatusEnum = Datahub.Core.Model.Datahub.TbsOpenGovSubmission.ProcessSteps;
@inject IUserInformationService _userService
@inject IDialogService _dialogService
@*
@inject IPublicDataFileService PublicDataFileService
@inject IMSGraphService GraphService
@inject UIControlsService UI
@inject NotifierService NotifierService
@using Datahub.Core.Services.Api
*@
@implements IDisposable

<MudText Typo=@Typo.h2>TBS Open Government Registry</MudText>

@if(SubmissionLoaded)
{

    <MudText Typo=@Typo.h3>Dataset: @Submission.DatasetTitle</MudText>
    
    <MudStack Spacing="6" >

        <MudCard>
            <MudCardHeader>
                <MudText Typo=@Typo.h3>Timeline</MudText>
                <MudSpacer />
                <MudButton OnClick=@ToggleTimeline >@(_timelineCollapsed? "Expand":"Collapse")</MudButton>
            </MudCardHeader>

            <MudCardContent>
                <DHSteps 
                    T=@StatusEnum
                    StepItems=@_steps
                    CurrentStepStateFunc=@GetCurrentStepState
                    StepTitleFunc=@GetStepTitle
                    StepMessageFunc=@GetStepDescription
                    Collapsed=@_timelineCollapsed
                    />

            </MudCardContent>
        </MudCard>

        @if (ShowMetadataEntryForm)
        {
            <MudCard>
                <MudCardHeader>
                    <MudText Typo=@Typo.h3>Submission Metadata</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <TbsOpenGovSubmissionMetadataEditor Submission=@Submission />
                </MudCardContent>
            </MudCard>
        }

        @if (ShowOpenGovCriteriaForm)
        {
            <MudCard>
                <MudCardHeader>
                    <MudText Typo=@Typo.h3>Open Gov Publishing Criteria</MudText>
                </MudCardHeader>

                <Datahub.Portal.Pages.Forms.ShareWorkflow.ApprovalForm ApprovalFormId=@_approvalFormId
                                                               OnSubmitForm=@UpdateApprovalFormId
                                                               DatasetTitle=@Submission.DatasetTitle
                                                               PortalUser=@_requestingUser />
            </MudCard>
        }

        @if(ShowFileSelectionPane)
        {
            <MudCard>
                <MudCardHeader>
                    <MudText Typo=@Typo.h3>Select Files</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudList>
                    @foreach (var p in SUBMISSION_FILE_PURPOSES) 
                    {
                        <MudListItem>
                            <MudStack Row>
                                <Datahub.Core.Components.OpenDataSharing.FilePurposeSelector 
                                    FilePurpose=@p
                                    Submission=@Submission
                                    Syncer=@Syncer
                                    Required=@IsPurposeRequired(p)
                                    MultiSelect=@IsPurposeMultiSelectable(p)
                                />
                                <MudTooltip Text=@Localizer["Edit File Info"]>
                                     <div class="reader-only">@Localizer["Edit File Info"]</div>
                                     <MudIconButton 
                                         Icon=@Icons.Material.Filled.Edit 
                                         Disabled=@(!HasFileSelectedForPurpose(p))
                                         OnClick=@(async () => await ShowFileInfoDialog(p))
                                     />
                                </MudTooltip>
                            </MudStack>

                        </MudListItem>

                    }
                        @* <MudListItem>
                            <Datahub.Core.Components.OpenDataSharing.FilePurposeSelector 
                                FilePurpose=@TbsOpenGovSubmission.METADATA_FILE_TYPE
                                Submission=@Submission
                                Syncer=@Syncer
                                Required
                            />
                        </MudListItem>
                        <MudListItem>
                            <Datahub.Core.Components.OpenDataSharing.FilePurposeSelector 
                                FilePurpose=@TbsOpenGovSubmission.DATA_DICTIONARY_FILE_TYPE
                                Submission=@Submission
                                Syncer=@Syncer
                                Required
                            />
                        </MudListItem>
                        <MudListItem>
                            <Datahub.Core.Components.OpenDataSharing.FilePurposeSelector
                                FilePurpose=@TbsOpenGovSubmission.SUPPORTING_DOC_FILE_TYPE
                                MultiSelect
                                Submission=@Submission
                                Syncer=@Syncer 
                            />
                        </MudListItem> *@
                    </MudList>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Color=@Color.Primary Variant=@Variant.Filled OnClick=@UpdateSubmission >Update</MudButton>
                    <MudSpacer />
                    <MudButton>Add files</MudButton> 
                </MudCardActions>
            </MudCard>
        }

        @if (ShowImsoApprovalPane)
        {
            <MudCard>
                <MudCardHeader>
                    <MudText Typo=@Typo.h3>IMSO Approval</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Row>
                        @* user selector *@
                        <MudTextField T=@string Label=@Localizer["IMSO Email"] />
                        @if (Submission.ImsoApprovalRequested)
                        {
                            <MudTooltip Text=@Localizer["IMSO Approval request has been sent"]>
                                <div class="reader-only">@Localizer["IMSO Approval request has been sent"]</div>
                                <MudIcon Icon=@Icons.Material.Filled.Check Color=@Color.Success Size=@Size.Large />
                            </MudTooltip>
                        }
                        <MudButton OnClick=@SendImsoApprovalRequest>@Localizer["Send approval request"]</MudButton>
                    </MudStack>
                    <MudStack Row>
                        <Datahub.Core.Components.OpenDataSharing.FilePurposeSelector 
                            FilePurpose=@TbsOpenGovSubmission.IMSO_APPROVAL_FILE_TYPE
                            Submission=@Submission
                            Syncer=@Syncer
                        />
                        <MudButton 
                            Variant=@Variant.Filled 
                            Color=@Color.Primary 
                            Disabled=@(!HasFileSelectedForPurpose(TbsOpenGovSubmission.IMSO_APPROVAL_FILE_TYPE))
                            OnClick=@SubmitImsoApprovalDocument
                        >@Localizer["Submit"]</MudButton>
                    </MudStack>
                </MudCardContent>

            </MudCard>
        }

    </MudStack>

}


@code {

    [Parameter]
    public TbsOpenGovSubmission Submission { get; set; }

    [Parameter]
    public EventCallback OnSubmissionUpdated { get; set; }

    private bool _timelineCollapsed = true;
    private async Task ToggleTimeline()
    {
        _timelineCollapsed = !_timelineCollapsed;
        await InvokeAsync(StateHasChanged);
    }

    private GenericSyncer Syncer = new();

    private bool SubmissionLoaded => Submission != null;

    private bool ShowMetadataEntryForm => true; //TODO
    private bool ShowOpenGovCriteriaForm => _stepStates[StatusEnum.Initial] == DHSteps<StatusEnum>.StepState.Running;
    private bool ShowFileSelectionPane => _stepStates[StatusEnum.AwaitingFiles] == DHSteps<StatusEnum>.StepState.Running;
    private bool ShowImsoApprovalPane => true; //TODO

    private Dictionary<StatusEnum, DHSteps<StatusEnum>.StepState> _stepStates = new();
    private Dictionary<StatusEnum, (string, string)?> _stepInfo = new();

    private List<StatusEnum> _steps = Enum.GetValues<StatusEnum>().ToList();

    private (string, string)? GetStepPair(StatusEnum status)
    {
        var prefix = $"{TbsOpenGovSubmission.LOCALIZATION_PREFIX}.Status";
        var title = $"{prefix}.{status}.Title";
        var desc = $"{prefix}.{status}.Description";
        return (Localizer[title], Localizer[desc]);
    }

    private DHSteps<StatusEnum>.StepState GetCurrentStepState(StatusEnum s) => _stepStates[s];
    private StatusEnum? _currentStep;
    private (string, string)? GetStepInfo(StatusEnum s) => s == _currentStep || !_timelineCollapsed ? _stepInfo[s] : new(string.Empty, string.Empty);
    private string GetStepTitle(StatusEnum s) => GetStepInfo(s)?.Item1;
    private string GetStepDescription(StatusEnum s) => GetStepInfo(s)?.Item2;

    private int _approvalFormId = 0;
    private string _datasetTitle;
    private PortalUser _requestingUser;

    private static readonly string[] SUBMISSION_FILE_PURPOSES = new string[]
    {
        TbsOpenGovSubmission.DATASET_FILE_TYPE,
        TbsOpenGovSubmission.METADATA_FILE_TYPE,
        TbsOpenGovSubmission.DATA_DICTIONARY_FILE_TYPE,
        TbsOpenGovSubmission.SUPPORTING_DOC_FILE_TYPE
    };
    private static readonly string[] REQUIRED_SUBMISSION_FILE_PURPOSES = new string[]
    {
        TbsOpenGovSubmission.DATASET_FILE_TYPE,
        TbsOpenGovSubmission.DATA_DICTIONARY_FILE_TYPE
    };
    private static readonly string[] MULTI_SELECTABLE_FILE_PURPOSES = new string[]
    {
        TbsOpenGovSubmission.DATASET_FILE_TYPE,
        TbsOpenGovSubmission.SUPPORTING_DOC_FILE_TYPE
    };

    private bool HasFileSelectedForPurpose(string purpose) => Submission?.Files?.Any(f => f.FilePurpose == purpose) ?? false;
    private OpenDataPublishFile GetFirstFileWithPurpose(string purpose) => Submission?.Files?.FirstOrDefault(f => f.FilePurpose == purpose);
    private bool IsPurposeRequired(string purpose) => REQUIRED_SUBMISSION_FILE_PURPOSES.Contains(purpose);
    private bool IsPurposeMultiSelectable(string purpose) => MULTI_SELECTABLE_FILE_PURPOSES.Contains(purpose);

    private async Task ShowFileInfoDialog(string initialFilePurpose)
    {
        var file = GetFirstFileWithPurpose(initialFilePurpose);

        var dialogParams = new DialogParameters<EditFileInformationDialog>();
        dialogParams.Add(x => x.Submission, Submission);
        dialogParams.Add(x => x.InitialFile, file);

        var dialogOptions = new DialogOptions() { MaxWidth = MaxWidth.Medium, FullWidth = true };

        await _dialogService.ShowAsync<EditFileInformationDialog>(Localizer["Edit File Information"], dialogParams, dialogOptions);
    }

    private async Task UpdateApprovalFormId(Forms.ShareWorkflow.ApprovalFormSubmitArgs args)
    {
        //TODO 

        _approvalFormId = args.FormId;

        Submission.OpenGovCriteriaMetDate = DateTime.Today;

        await UpdateSubmission();

        await Task.CompletedTask;
    }

    private async Task SendImsoApprovalRequest()
    {
        //TODO
        Submission.ImsoApprovalRequestDate = DateTime.Today;
        await UpdateSubmission();
        await Task.CompletedTask;
    }

    private async Task SubmitImsoApprovalDocument()
    {
        Submission.ImsoApprovedDate = DateTime.Today;
        await UpdateSubmission();
    }

    private async Task UpdateSubmission()
    {
        SetStatusSteps();
        await Task.CompletedTask;
        //if (OnSubmissionUpdated.HasDelegate)
        //{
        //    await OnSubmissionUpdated.InvokeAsync();
        //}
    }

    private void SetStatusSteps()
    {
        if (!SubmissionLoaded) return;

        _currentStep = null;

        _stepStates = _steps
            .Select(s => TbsOpenGovPublishingUtils.CheckStepStatus(Submission, s))
            .ToDictionary(s => s.Step, s => s.Completed ? 
                DHSteps<StatusEnum>.StepState.Passed : 
                s.Started ? 
                    DHSteps<StatusEnum>.StepState.Running : 
                    DHSteps<StatusEnum>.StepState.Queued);

        if (_stepStates[StatusEnum.Published] == DHSteps<StatusEnum>.StepState.Passed)
        {
            _currentStep = StatusEnum.Published;
        }
        else
        {
            _currentStep = _stepStates.OrderBy(kvp => kvp.Key).FirstOrDefault(kvp => kvp.Value == DHSteps<StatusEnum>.StepState.Running).Key;
        }
    }

    protected override void OnParametersSet()
    {
        SetStatusSteps();
        base.OnParametersSet();
    }

    protected override async Task OnInitializedAsync()
    {
        _stepInfo = _steps.ToDictionary(s => s, s => GetStepPair(s));
        _stepStates = _steps.ToDictionary(s => s, s => DHSteps<StatusEnum>.StepState.Queued);

        SetStatusSteps();

        _requestingUser = Submission?.RequestingUser ?? await _userService.GetCurrentPortalUserAsync();

        if (Syncer != null) Syncer.Notify += StateHasChanged;

        await base.OnInitializedAsync();
    }

    public void Dispose()
    {
        if (Syncer != null) Syncer.Notify -= StateHasChanged;
    }
}

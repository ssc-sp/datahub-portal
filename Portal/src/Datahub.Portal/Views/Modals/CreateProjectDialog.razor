@using Datahub.Application.Services
@inject IProjectCreationService ProjectCreationService

<MudDialog>
    <DialogContent>
        <MudForm Class="my-4" @bind-IsValid="@_success">
            <MudTextField T="string" @bind-Value="_projectTitle" Label="@Localizer[WorkspaceLabel]" Required
                          RequiredError="@Localizer[MissingTitle]" HelperText="@Localizer[WorkspaceHelper]"
                          DebounceInterval="500" OnDebounceIntervalElapsed="UpdateProjectAcronym"/>
            <MudTextField T="string" @bind-Value="_projectAcronym" Label="@Localizer[AcronymLabel]" AdornmentIcon="@AcronymGeneratorIcon"
                          HelperText="@Localizer[AcronymHelper]" Adornment="Adornment.End" OnAdornmentClick="GenerateAcronym"
                          RequiredError="@Localizer[MissingAcronym]" Converter="_converter" @ref="_acronymField" Required
                          Validation="@(new Func<string, Task<string>>(ValidateAcronym))"/>
            @if (_errorMessage is not null)
            {
                <MudAlert Severity="Severity.Error" Dense="true" Class="my-2" ShowCloseIcon CloseIconClicked="CloseAlert">
                    @_errorMessage
                </MudAlert>
            }
        </MudForm>
    </DialogContent>
    <DialogActions>
        @if (ShowCancel)
        {
            <MudButton Variant="Variant.Text" OnClick="CloseDialog">@Localizer[CancelButton]</MudButton>
        }
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="!_success" OnClick="CreateProject">
            @if (_isCreating)
            {
                <MudProgressCircular Class="ms-n1 mr-2" Size="Size.Small" Indeterminate="true"/>
            }
            @Localizer[CreateButton]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {

    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public bool ShowCancel { get; set; } = true;

#nullable enable
    private const string WorkspaceLabel = "Workspace Title";
    private const string WorkspaceHelper = "Enter a descriptive title for the workspace";
    private const string AcronymLabel = "Workspace Acronym";
    private const string AcronymHelper = "A unique alphanumeric acronym to identify the workspace";
    private const string AcronymGeneratorIcon = "fa-light fa-arrows-rotate";
    private const string AcronymGeneratorTooltip = "Generate a unique acronym";
    private const string WorkspaceException = "An error occurred while creating the workspace";
    private const string CreateButton = "Create Workspace";
    private const string CancelButton = "Cancel";

    private const string MissingTitle = "Workspace Title is required";
    private const string MissingAcronym = "Workspace Acronym is required";
    private const string AcronymExists = "Workspace Acronym already exists";
    private const string WorkspaceRequiredToGenerateAcronym = "Workspace Title is required to generate an acronym";

    private const string DefaultOrganizationName = "Unspecified";

    private string? _errorMessage;
    private string _projectTitle = string.Empty;
    private string _projectAcronym = string.Empty;
    private MudTextField<string>? _acronymField;

    private bool _success;
    private bool _isCreating;
        private const int MaxAcronymLength = 7;


    private async Task GenerateAcronym()
    {
        if (string.IsNullOrWhiteSpace(_projectTitle))
        {
            _errorMessage = Localizer[WorkspaceRequiredToGenerateAcronym];
            return;
        }
        _projectAcronym = await ProjectCreationService.GenerateProjectAcronymAsync(_projectTitle);
        _success = true;
        _acronymField?.ResetValidation();
    }

    private void CloseAlert()
    {
        _errorMessage = null;
    }

    private void CloseDialog()
    {
        MudDialog.Cancel();
    }

    private async Task<string?> ValidateAcronym(string acronym)
    {
        if (await ProjectCreationService.AcronymExists(acronym))
            return Localizer[AcronymExists];

        return (acronym.Length > MaxAcronymLength ? Localizer["Acronym must be {0} characters or less", MaxAcronymLength] : null)!;
    }

    private Converter<string> _converter = new Converter<string>
    {
        SetFunc = value => value?.ToUpperInvariant() ?? string.Empty,
        GetFunc = text => text?.ToUpperInvariant() ?? string.Empty,
    };

    private async Task UpdateProjectAcronym()
    {
        if (string.IsNullOrWhiteSpace(_projectTitle)) return;
        _projectAcronym = await ProjectCreationService.GenerateProjectAcronymAsync(_projectTitle);
    }

    private async Task CreateProject()
    {
        if (_success)
        {
            if (_isCreating)
                return;
            _isCreating = true;
            //update Button
            StateHasChanged();
            await Task.Delay(1);
            // TODO: Get Organization name?
            var isAdded = await ProjectCreationService.CreateProjectAsync(_projectTitle, _projectAcronym, DefaultOrganizationName);
            _isCreating = false;
            if (isAdded)
            {
                MudDialog.Close(DialogResult.Ok(_projectAcronym));
            }
            else
            {
                _errorMessage = Localizer[WorkspaceException];
                StateHasChanged();
            }
        }
    }
#nullable disable
}
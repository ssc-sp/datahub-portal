@*ProjectObjectMetadata.razor*@

@using Datahub.Core.Services.CatalogSearch;
@using Datahub.Metadata.DTO
@using Datahub.Metadata.Model
@using Datahub.Core
@using Datahub.Core.Model.Projects
@using Datahub.Metadata.Utils;
@inject NavigationManager NavigationManager
@inject IDbContextFactory<DatahubProjectDBContext> ContextFactory
@inject IOrganizationLevelsService OrganizationLevelsService
@inject ILogger<ProjectObjectMetadata> Logger
@inject ISnackbar _snackbar
@inject IDatahubCatalogSearch _datahubCatalogSearch

@if (_project is not null)
{
    <ObjectMetadataEditor @ref="_editor"
                          @key=@ObjectId
                          ObjectId=@ObjectId
                          DefaultMetadataId=@DefaultMetadaId
                          ProfileName=@ProfileName
                          Location=@Location
                          ProjectId=@_project.ProjectID
                          ObjectType=@ObjectType
                          SecurityClass=@GetProjectSensitivity()
                          SaveButtonLabel=@GetSaveButtonLabel()
                          OnSave=@HandleSave
                          OnDiscard=@(AllowDiscard ? HandleNavigateToProject : null)
                          OnNewMetadataCreated=@OnMetadataCreated
                          OnExistingMetadataLoaded=@OnMetadataCreated
                          UpdateCatalog="false"
                          ValidateRequired=@ValidateRequired/>
}

@code {

    [Parameter]
    public string ProjectAcronym { get; set; }

    [Parameter]
    public string ProfileName { get; set; }

    [Parameter]
    public string ObjectId { get; set; }

    [Parameter]
    public MetadataObjectType ObjectType { get; set; }

    [Parameter]
    public string Location { get; set; }

    [Parameter]
    public bool UpdateCatalog { get; set; } = true;

    [Parameter]
    public string SaveButtonLabel { get; set; }

    [Parameter]
    public bool HideTranslationNote { get; set; }

    [Parameter]
    public bool NavigateToProject { get; set; } = true;

    [Parameter]
    public bool ValidateRequired { get; set; } = true;

    [Parameter]
    public EventCallback<DatahubProject> OnProjectLoaded { get; set; }

    [Parameter]
    public EventCallback<DatahubProject> OnMetadataSaved { get; set; }

    [Parameter]
    public bool AllowDiscard { get; set; } = true;

    private string DefaultMetadaId => ObjectId != ProjectAcronym ? ProjectAcronym : null;

    private DatahubProject _project;
    private int? _sector;
    private int? _branch;
    private ObjectMetadataEditor _editor;

    protected override async Task OnInitializedAsync()
    {
        using var ctx = await ContextFactory.CreateDbContextAsync();
        _project = await ctx.Projects.Include(p => p.Resources)
            .AsSingleQuery()
            .FirstOrDefaultAsync(p => p.ProjectAcronymCD == ProjectAcronym);
        if (_project is not null)
        {
            await TryReadProjectSectorAndBranch();
            await OnProjectLoaded.InvokeAsync(_project);
        }
    }

    private async Task TryReadProjectSectorAndBranch()
    {
        var sectors = await OrganizationLevelsService.GetSectors();
        _sector = FindOrganizationLevelId(sectors, _project.SectorName);
        var branches = await OrganizationLevelsService.GetBranches();
        _branch = FindOrganizationLevelId(branches, _project.BranchName);
    }

    private int? FindOrganizationLevelId(List<DHOrganizationLevel> levels, string value)
    {
        if (!string.IsNullOrEmpty(value))
            return levels.FirstOrDefault(l => MatchesLevelWithName(l, value))?.Id;
        return default;
    }

    private bool MatchesLevelWithName(DHOrganizationLevel level, string value)
    {
        var mode = StringComparison.OrdinalIgnoreCase;
        return value.Equals(level.EnglishLabel, mode) ||
               value.Equals(level.FrenchLabel, mode) ||
               value.Equals(level.EnglishAcronym, mode) ||
               value.Equals(level.FrenchAcronym, mode);
    }

    private void OnMetadataCreated()
    {
        if (string.IsNullOrEmpty(_editor.GetValue(FieldNames.nameEn)))
            _editor.SetValue(FieldNames.nameEn, _project.Project_Name);

        if (string.IsNullOrEmpty(_editor.GetValue(FieldNames.nameFr)))
            _editor.SetValue(FieldNames.nameFr, _project.ProjectNameFr);

        if (string.IsNullOrEmpty(_editor.GetValue(FieldNames.acronym)))
            _editor.SetValue(FieldNames.acronym, _project.ProjectAcronymCD);

        if (string.IsNullOrEmpty(_editor.GetValue(FieldNames.descriptionEn)))
            _editor.SetValue(FieldNames.descriptionEn, _project.ProjectSummaryDesc);

        if (string.IsNullOrEmpty(_editor.GetValue(FieldNames.descriptionFr)))
            _editor.SetValue(FieldNames.descriptionFr, _project.ProjectSummaryDescFr);
    }

    private async Task HandleSave(FieldValueContainer values)
    {
        try
        {
            await OnMetadataSaved.InvokeAsync(_project);

            // Metadata is "added" only when the profile required fields are entered
            _project.MetadataAdded = _editor.ValidProfileFields();

            var sector = _editor.GetSelectedChoices("sector").FirstOrDefault();
            if (sector is not null)
                _project.SectorName = sector.Label;

            var branch = _editor.GetSelectedChoices("branch").FirstOrDefault();
            if (branch is not null)
                _project.BranchName = branch.Label;

            var name_en = _editor.GetValue(FieldNames.nameEn);
            if (!string.IsNullOrEmpty(name_en))
                _project.Project_Name = name_en;

            var name_fr = _editor.GetValue(FieldNames.nameFr);
            if (!string.IsNullOrEmpty(name_fr))
                _project.ProjectNameFr = name_fr;

            var desc_en = _editor.GetValue(FieldNames.descriptionEn);
            if (!string.IsNullOrEmpty(desc_en))
                _project.ProjectSummaryDesc = desc_en;

            var desc_fr = _editor.GetValue(FieldNames.descriptionFr);
            if (!string.IsNullOrEmpty(desc_en))
                _project.ProjectSummaryDescFr = desc_fr;

            using var ctx = await ContextFactory.CreateDbContextAsync();
            ctx.Attach(_project);
            ctx.Projects.Update(_project);
            await ctx.SaveChangesAsync();

            var catalogObject = new Core.Model.Catalog.CatalogObject()
            {
                ObjectType = Core.Model.Catalog.CatalogObjectType.Workspace,
                ObjectId = _project.ProjectAcronymCD,
                NameEnglish = _project.Project_Name,
                NameFrench = _project.ProjectNameFr,
                DescEnglish = _project.ProjectSummaryDesc,
                DescFrench = _project.ProjectSummaryDescFr
            };
            await _datahubCatalogSearch.AddCatalogObject(catalogObject);

            _snackbar.Add(Localizer["Successfully saved project metadata."], Severity.Success);
            HandleNavigateToProject();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Internal error updating project object metadata.");
        }
    }

    private void HandleNavigateToProject()
    {
        if (NavigateToProject)
            NavigationManager.NavigateTo($"/w/{ProjectAcronym}");
    }

    private string GetProjectSensitivity()
    {
        var sensitivity = (_project?.DataSensitivity ?? "").ToUpper();
        return sensitivity switch
        {
            "CLASSIFIED" or
            "PROTECTED B" => SecurityClassification.ProtectedB,
            "PROTECTED A" => SecurityClassification.ProtectedA,
            _ => SecurityClassification.Unclassified
        };
    }

    private string GetSaveButtonLabel() => SaveButtonLabel ?? Localizer["Save"];
}
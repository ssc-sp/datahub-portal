@using Datahub.Core.Model.Datahub
@using Datahub.Core.Model.Projects
@using Datahub.Shared.Entities

@inject IRequestManagementService RequestManagementService
@inject ISnackbar _snackbar

<ToolCard Title="@Descriptor?.Title"
          Subtitle="@Descriptor?.CatalogSubtitle"
          Description="@Descriptor?.CatalogDescription"
          ReadMorePath="@GitHubModule?.ReadMorePath"
          Tags="@Descriptor?.Tags?.ToList()">
    <Logo>
        @if (IsIconSvg)
        {
            <img src="@Icon" alt="@Descriptor?.Title">
        }
        else
        {
            <MudIcon Icon="@Icon" Color="Color.Secondary"/>
        }
    </Logo>
    <ToolActionsList>
        @if (TemplateName == TerraformTemplate.ContactUs)
        {
@*            <ViewExternalLinkButton ExternalUrl="@GitHubModule?.DocumentationUrl" Text="@Localizer["View Discussions"]"/>
*@        <ViewExternalLinkButton 
                Variant="Variant.Filled" 
                ExternalUrl="@Descriptor?.ActionURL" 
                Text="@Descriptor?.ActionDescription" 
                Icon= "fa-solid fa-comments-question-check"
                />
        }
        else
        {
            
            @* Hide for POC Stage 2 *@
            @* <CostEstimatorButton TemplateName="@TemplateName"/> *@
            <RequestingButton 
                IsRunning="_isRunning" 
                ResourceRequested="ResourceRequested" 
                ResourceCreated="ResourceCreated"
                Project="Project" 
                ModuleStatus="@GitHubModule?.Status"
                IsResourceWhitelisted="IsResourceWhitelisted"
                OnRequestService="@HandleRequestService"
                />
        }
    </ToolActionsList>
</ToolCard>


@code {

    [Parameter]
    public GitHubModuleDescriptor? Descriptor { get; set; }

    [Parameter]
    public GitHubModule? GitHubModule { get; set; }

    [Parameter]
    public bool IsIconSvg { get; set; }

    [Parameter]
    public bool ResourceRequested { get; set; }
    
    [Parameter]
    public bool ResourceCreated { get; set; }

    [Parameter]
    public Datahub_Project? Project { get; set; }
    
    [Parameter]
    public bool? IsResourceWhitelisted { get; set; }

    private bool _isRunning;
    private string Icon => GitHubModule?.Icon ?? "fa-solid fa-cloud-question";
    private string? TemplateName => GitHubModule?.Name;

    private async Task HandleRequestService()
    {
        _isRunning = true;
        // ResourceRequested = await RequestManagementService.HandleTerraformRequestServiceAsync(Project, TemplateName);
        if (ResourceRequested)
        {
            _snackbar.Add(Localizer["Resource request has been successfully submitted"], Severity.Success);
        }
        else
        {
            _snackbar.Add(Localizer["Resource request has failed, please contact an administrator"], Severity.Error);
        }
        _isRunning = false;
    }

}